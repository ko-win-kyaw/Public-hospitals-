<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmotioN Group Chat Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        :root { --purple: #800080; --bg: #f0f2f5; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Header */
        .chat-header { background: var(--purple); color: white; padding: 0 15px; display: flex; align-items: center; position: fixed; top: 0; width: 100%; z-index: 2000; justify-content: space-between; height: 60px; }
        
        /* Chat Box */
        #chatBox { flex: 1; overflow-y: auto; padding: 75px 15px 145px 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 15px; font-size: 14px; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-end; background: var(--purple); color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; }
        .msg img { width: 100%; max-width: 250px; border-radius: 10px; margin-top: 5px; display: block; }
        .sender-name { font-size: 10px; font-weight: bold; margin-bottom: 3px; display: block; color: #888; }
        .msg-time { font-size: 9px; display: block; margin-top: 4px; text-align: right; opacity: 0.7; }

        /* Footer & Nav */
        .footer-wrapper { position: fixed; bottom: 0; width: 100%; background: white; z-index: 1000; display: flex; flex-direction: column; border-top: 1px solid #eee; }
        .input-area { display: flex; align-items: center; gap: 8px; padding: 8px 12px; height: 60px; }
        .input-box { flex: 1; background: #f1f1f1; border: none; padding: 10px 15px; border-radius: 25px; outline: none; }
        .btn-send { background: var(--purple); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .bottom-nav { height: 60px; display: flex; justify-content: space-around; align-items: center; background: white; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; font-size: 10px; }
        .nav-item img { width: 24px !important; height: 24px !important; margin-bottom: 3px; object-fit: contain; }

        /* Modal & Group List */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; max-height: 70vh; overflow-y: auto; }
        .user-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .checkbox { width: 18px; height: 18px; }
    </style>
</head>
<body>

    <header class="chat-header">
        <div style="display: flex; align-items: center;">
            <span onclick="history.back()" style="margin-right:15px; cursor:pointer; font-size: 20px;">‚Üê</span>
            <b id="roomName">Loading Group...</b>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button id="adminBtn" onclick="location.href='admin.html'" style="display:none; background:white; color:var(--purple); border:none; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:bold;">üõ† Admin</button>
            <button onclick="showGroupModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">üë•</button>
        </div>
    </header>

    <div id="chatBox"></div>

    <div class="footer-wrapper">
        <div class="input-area">
            <label for="fileIn" style="cursor:pointer; font-size:22px;">üñºÔ∏è</label>
            <input type="file" id="fileIn" hidden onchange="uploadChatImg(this)">
            <input type="text" id="msgIn" class="input-box" placeholder="·ÄÖ·Ä¨·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´...">
            <button class="btn-send" onclick="sendMsg()">‚û§</button>
        </div>
        <nav class="bottom-nav">
            <a href="user.html" class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946488.png"><span>User</span></a>
            <a href="group.html" class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/615/615075.png"><span>Group</span></a>
            <a href="profile.html" class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png"><span>Profile</span></a>
        </nav>
    </div>

    <div id="groupModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--purple); margin-bottom:10px;">Group ·Ä°·Äû·ÄÖ·Ä∫·Äñ·ÄΩ·Ä≤·Ä∑·Äõ·Äî·Ä∫</h3>
            <input type="text" id="groupNameIn" placeholder="Group ·Ä°·Äô·Ää·Ä∫..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
            <div id="userSelectionArea" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
            <div style="display:flex; gap:10px;">
                <button onclick="createGroup()" style="flex:1; background:var(--purple); color:white; border:none; padding:10px; border-radius:8px;">·Äñ·ÄΩ·Ä≤·Ä∑·ÄÖ·Ää·Ä∫·Ä∏·Äô·Ää·Ä∫</button>
                <button onclick="closeModal()" style="flex:1; background:#ccc; border:none; padding:10px; border-radius:8px;">·Äï·Äö·Ä∫·Äñ·Äª·ÄÄ·Ä∫</button>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const notifySound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

    let roomId = new URLSearchParams(window.location.search).get('id');
    let selectedUsers = [];
    const adminUid = "d9O9wPCOkHekC6VqHjshmY8T1fJ2";

    auth.onAuthStateChanged(user => {
        if (user) { 
            if (user.uid === adminUid) document.getElementById('adminBtn').style.display = 'block';
            if(roomId) startChatSession();
        } else { window.location.href="login.html"; }
    });

    async function startChatSession() {
        const doc = await db.collection("rooms").doc(roomId).get();
        if(doc.exists) document.getElementById('roomName').innerText = doc.data().name;
        loadChat();
    }

    function loadChat() {
        const box = document.getElementById('chatBox');
        db.collection("rooms").doc(roomId).collection("messages").orderBy("createdAt", "asc").onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const d = change.doc.data();
                    const isMe = d.uid === auth.currentUser.uid;
                    if (!isMe) notifySound.play();
                    const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "just now";
                    const div = document.createElement('div');
                    div.className = `msg ${isMe ? 'sent' : 'received'}`;
                    div.innerHTML = `${!isMe ? `<span class="sender-name">${d.author}</span>` : ''} ${d.img ? `<img src="${d.img}">` : ''} ${d.text ? `<p>${d.text}</p>` : ''} <span class="msg-time">${time}</span>`;
                    box.appendChild(div);
                }
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    async function sendMsg() {
        const val = document.getElementById('msgIn').value.trim();
        if(!val || !roomId) return;
        const name = auth.currentUser.displayName || "User";
        document.getElementById('msgIn').value = "";
        await db.collection("rooms").doc(roomId).collection("messages").add({
            uid: auth.currentUser.uid, author: name, text: val, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    async function showGroupModal() {
        document.getElementById('groupModal').style.display = 'flex';
        const area = document.getElementById('userSelectionArea');
        area.innerHTML = "·Äõ·Äæ·Ä¨·Äñ·ÄΩ·Ä±·Äî·Ä±·Äû·Ää·Ä∫...";
        const snap = await db.collection("users").get();
        area.innerHTML = "";
        snap.forEach(doc => {
            const u = doc.data();
            if (u.uid !== auth.currentUser.uid) {
                const d = document.createElement('div');
                d.className = "user-item";
                d.innerHTML = `<input type="checkbox" class="checkbox" value="${u.uid}" data-name="${u.displayName || u.name}"> <span>${u.displayName || u.name}</span>`;
                area.appendChild(d);
            }
        });
    }

    async function createGroup() {
        const gName = document.getElementById('groupNameIn').value.trim();
        const checked = document.querySelectorAll('.checkbox:checked');
        if(!gName || checked.length === 0) return alert("·Ä°·Äô·Ää·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Ä°·Äñ·ÄΩ·Ä≤·Ä∑·Äù·ÄÑ·Ä∫·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´");

        let members = [auth.currentUser.uid];
        checked.forEach(c => members.push(c.value));

        const newRoom = await db.collection("rooms").add({
            name: gName,
            members: members,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            type: "group"
        });
        window.location.href = `chat.html?id=${newRoom.id}`;
    }

    async function uploadChatImg(input) {
        const fd = new FormData(); fd.append('image', input.files[0]);
        const res = await fetch("https://api.imgbb.com/1/upload?key=C8d8d00185e973ebcafddd34f77a1176", {method:'POST', body:fd});
        const d = await res.json();
        if(d.success) {
            await db.collection("rooms").doc(roomId).collection("messages").add({
                uid: auth.currentUser.uid, author: auth.currentUser.displayName || "User", img: d.data.url, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    }

    function closeModal() { document.getElementById('groupModal').style.display='none'; }
</script>
</body>
</html>
