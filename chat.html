<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmotioN Smart Chat</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://openfpcdn.io/fingerprintjs/v4"></script>
    <style>
        :root { --purple: #800080; --bg: #f0f2f5; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        .chat-header { background: var(--purple); color: white; padding: 12px 15px; display: flex; align-items: center; position: fixed; top: 0; width: 100%; z-index: 100; justify-content: space-between; }
        #chatBox { flex: 1; overflow-y: auto; padding: 70px 15px 80px 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 15px; font-size: 14px; position: relative; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: var(--purple); color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg img { width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .sender-name { font-size: 10px; font-weight: bold; margin-bottom: 3px; display: block; color: #888; }
        .input-area { position: relative; bottom: 70px; width: 100%; background: white; padding: 10px; display: flex; align-items: center; gap: 8px; }
        .input-box { flex: 1; background: #eee; border: none; padding: 10px 15px; border-radius: 20px; outline: none; }
        .btn-send { background: var(--purple); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; max-height: 80vh; overflow-y: auto; }
        .user-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
                .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; font-size: 10px; }
        .nav-item img { width: 22px; height: 22px; margin-bottom: 4px; }
        .nav-item.active { color: var(--purple); font-weight: bold; }

    </style>
</head>
<body>

    <header class="chat-header">
        <div style="display: flex; align-items: center;">
            <span onclick="history.back()" style="margin-right:15px; cursor:pointer;">‚Üê</span>
            <b id="roomName">Loading Chat...</b>
        </div>
        <button onclick="showAddMember()" style="background:none; border:none; color:white; font-size:20px;">‚ûï</button>
    </header>

    <div id="chatBox"></div>

    <div class="input-area">
        <label for="fileIn" style="cursor:pointer; font-size:20px;">üñºÔ∏è</label>
        <input type="file" id="fileIn" hidden onchange="uploadChatImg(this)">
        <input type="text" id="msgIn" class="input-box" placeholder="·ÄÖ·Ä¨·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´...">
        <button class="btn-send" onclick="sendMsg()">‚û§</button>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:var(--purple); font-size: 18px;">·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äô·Ää·Ä∑·Ä∫·Äû·Ä∞·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´</h3>
                <span onclick="closeModal()" style="cursor:pointer; font-size:24px;">√ó</span>
            </div>
            <div id="userListArea"></div>
        </div>
    </div>
    <nav class="bottom-nav">
        <a href="user.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/1946/1946488.png"><span data-lang="nav_user">User</span>
        </a>
        <a href="group.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/615/615075.png"><span data-lang="nav_group">Group</span>
        </a>
        <a href="live.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/4404/4404094.png"><span data-lang="nav_live">Live</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png"><span data-lang="nav_profile">Profile</span>
        </a>
    </nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let roomId = new URLSearchParams(window.location.search).get('id');
    let chatListener = null;

    auth.onAuthStateChanged(user => {
        if (user) { 
            if(roomId) { startChatSession(); } else { showAddMember(); }
        } else { window.location.href="login.html"; }
    });

    function startChatSession() {
        if (chatListener) chatListener();
        loadChat();
        updateRoomTitle();
    }
    // --- showAddMember function ·ÄÄ·Ä≠·ÄØ ·Äí·ÄÆ·Ä°·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Ä°·ÄÖ·Ä¨·Ä∏·Äë·Ä≠·ÄØ·Ä∏·Äï·Ä´ ---
    async function showAddMember() {
        document.getElementById('addModal').style.display = 'flex';
        const listArea = document.getElementById('userListArea');
        listArea.innerHTML = "<p style='text-align:center;'>Loading accounts...</p>";
        
        try {
            // Firestore ·Äõ·Ä≤·Ä∑ "users" collection ·ÄÄ·Äî·Ä± ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äö·Ä∞·Äô·Äö·Ä∫
            const snap = await db.collection("users").get();
            listArea.innerHTML = "";
            
            snap.forEach(doc => {
                const u = doc.data();
                // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∑·Ä∫·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äô·Äï·Äº·Äñ·Ä≠·ÄØ·Ä∑ ·ÄÖ·ÄÖ·Ä∫·Äô·Äö·Ä∫
                if (u.uid && u.uid !== auth.currentUser.uid) {
                    const nameToShow = u.displayName || u.name || "·Ä°·Äô·Ää·Ä∫·Äô·Äû·Ä≠";
                    const div = document.createElement('div');
                    div.className = "user-item";
                    div.style = "padding:12px; border-bottom:1px solid #eee; cursor:pointer;";
                    div.innerHTML = `<b>${nameToShow}</b>`;
                    
                    // ·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ u.uid ·ÄÄ·Ä≠·ÄØ ·Äû·Ä±·ÄÅ·Äª·Ä¨ pass ·Äú·ÄØ·Äï·Ä∫·Äï·Ä±·Ä∏·Äõ·Äï·Ä´·Äô·Äö·Ä∫
                    div.onclick = () => startPrivateChat(u.uid, nameToShow);
                    listArea.appendChild(div);
                }
            });

            if (listArea.innerHTML === "") {
                listArea.innerHTML = "<p style='text-align:center;'>·Ä°·ÄÅ·Äº·Ä¨·Ä∏·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã</p>";
            }
        } catch (e) {
            console.error(e);
            listArea.innerHTML = "<p style='text-align:center; color:red;'>Error: " + e.message + "</p>";
        }
    }
    async function showAddMember() {
        document.getElementById('addModal').style.display = 'flex';
        const listArea = document.getElementById('userListArea');
        listArea.innerHTML = "<p style='text-align:center;'>Loading accounts...</p>";
        
        try {
            // users collection ·Äë·Ä≤·ÄÄ ·Äú·Ä∞·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·ÄÄ·ÄØ·Äî·Ä∫·Äö·Ä∞·Äô·Äö·Ä∫
            const snap = await db.collection("users").get();
            listArea.innerHTML = "";
            
            snap.forEach(doc => {
                const u = doc.data();
                // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∑·Ä∫·Ä°·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ·Äö·Ä∫ ·Äï·Äº·Äî·Ä∫·Äô·Äï·Äº·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·ÄÖ·ÄÖ·Ä∫·Äô·Äö·Ä∫
                if (u.uid && u.uid !== auth.currentUser.uid) {
                    const nameToShow = u.displayName || u.name || "·Ä°·Äô·Ää·Ä∫·Äô·Äû·Ä≠";
                    const div = document.createElement('div');
                    div.className = "user-item";
                    div.innerHTML = `<b>${nameToShow}</b>`;
                    // ·Äî·Äæ·Ä≠·Äï·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫ targetUid ·ÄÄ·Ä≠·ÄØ ·Äû·Ä±·ÄÅ·Äª·Ä¨ ·Äï·Ä≠·ÄØ·Ä∑·Äï·Ä±·Ä∏·Äõ·Äô·Äö·Ä∫
                    div.onclick = () => startPrivateChat(u.uid, nameToShow);
                    listArea.appendChild(div);
                }
            });

            if (listArea.innerHTML === "") {
                listArea.innerHTML = "<p style='text-align:center;'>·Ä°·ÄÅ·Äº·Ä¨·Ä∏·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã <br><small>(·Äê·ÄÅ·Äº·Ä¨·Ä∏·Äú·Ä∞·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫ Login ·Äù·ÄÑ·Ä∫·ÄÅ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äï·Ä´)</small></p>";
            }
        } catch (e) {
            listArea.innerHTML = "Error: " + e.message;
        }
    }

  async function startPrivateChat(targetUid, targetName) {
        const myUid = auth.currentUser.uid;
        const sortedIds = [myUid, targetUid].sort();
        const genId = `chat_${sortedIds[0]}_${sortedIds[1]}`;
        try {
            await db.collection("rooms").doc(genId).set({
                name: targetName,
                members: [myUid, targetUid],
                type: "private",
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            window.location.href = window.location.pathname + '?id=' + genId;
        } catch (e) { alert("Error: " + e.message); }
    }

    async function updateRoomTitle() {
        if (!roomId) return;
        const doc = await db.collection("rooms").doc(roomId).get();
        if(doc.exists) document.getElementById('roomName').innerText = doc.data().name;
    }

    function loadChat() {
        const box = document.getElementById('chatBox');
        chatListener = db.collection("rooms").doc(roomId).collection("messages").orderBy("createdAt", "asc").onSnapshot(snap => {
            box.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const isMe = d.uid === auth.currentUser.uid;
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                if(isMe) div.onclick = () => deleteMsg(doc.id);
                div.innerHTML = `
                    ${!isMe ? `<span class="sender-name">${d.author}</span>` : ''}
                    ${d.img ? `<img src="${d.img}" onclick="window.open('${d.img}')">` : ''}
                    ${d.text ? `<p>${d.text}</p>` : ''}
                `;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    async function sendMsg() {
        const val = document.getElementById('msgIn').value.trim();
        if(!val || !roomId) return;
        await db.collection("rooms").doc(roomId).collection("messages").add({
            uid: auth.currentUser.uid,
            author: auth.currentUser.displayName || "User",
            text: val,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msgIn').value = "";
    }

    async function uploadChatImg(input) {
        if(!input.files[0] || !roomId) return;
        const fd = new FormData();
        fd.append('image', input.files[0]);
        try {
            const res = await fetch("https://api.imgbb.com/1/upload?key=C8d8d00185e973ebcafddd34f77a1176", { method:'POST', body:fd });
            const d = await res.json();
            if(d.success) {
                await db.collection("rooms").doc(roomId).collection("messages").add({
                    uid: auth.currentUser.uid,
                    author: auth.currentUser.displayName || "User",
                    img: d.data.url,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        } catch (e) { alert("Upload failed"); }
    }

    async function deleteMsg(id) {
        if(confirm("·Äñ·Äª·ÄÄ·Ä∫·Äô·Äæ·Ä¨·Äú·Ä¨·Ä∏ Senior?")) {
            await db.collection("rooms").doc(roomId).collection("messages").doc(id).delete();
        }
    }
    function closeModal() { document.getElementById('addModal').style.display='none'; }
</script>
</body>
</html>
