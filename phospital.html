<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Page - Senior Final Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        :root { --p: #800080; --bg: #f0f2f5; }
        body { background: var(--bg); margin: 0; font-family: sans-serif; padding-bottom: 70px; }
        .header-box { background: white; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding-bottom: 12px; }
        .cover-area { width: 100%; height: 180px; background: #ddd; position: relative; }
        .cover-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-area { padding: 15px; margin-top: -50px; display: flex; align-items: flex-end; gap: 12px; }
        .p-img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; object-fit: cover; background: #eee; }
        .card { background: white; margin: 12px; padding: 15px; border-radius: 12px; position: relative; }
        .post-media { width: 100%; border-radius: 8px; margin-top: 10px; background: #000; }
        .admin-only { display: none; }
        .interaction { display: flex; justify-content: space-around; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; font-size: 13px; font-weight: bold; }
        .btn-main { background: var(--p); color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; }
        
        .search-container { margin: 10px 15px; position: relative; }
        .search-box { display: flex; background: #f0f2f5; border-radius: 20px; padding: 8px 15px; border: 1px solid #ddd; align-items: center; }
        .search-box input { border: none; outline: none; flex: 1; background: transparent; padding-left: 5px; }
        #searchResults { position: absolute; width: 100%; background: white; z-index: 100; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); top: 45px; display: none; }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

        .comment-box { margin-top: 10px; border-top: 1px solid #eee; display: none; }
        .c-item { background: #f0f2f5; padding: 10px; border-radius: 12px; margin-top: 8px; font-size: 13px; }
        .time-label { font-size: 10px; color: #999; margin-left: 5px; }
                                .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; font-size: 10px; }
        .nav-item img { width: 22px; height: 22px; margin-bottom: 4px; }
        .nav-item.active { color: var(--purple); font-weight: bold; }
.post-media { 
    width: 100%; 
    height: 200px; /* fixed height á€‘á€¬á€¸á€™á€¾ grid á€Šá€®á€™á€¾á€¬á€•á€« */
    object-fit: cover; 
    border-radius: 8px; 
}
/* Image Modal Style */
#imgModal { display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
#imgModal img { max-width: 95%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
.modal-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header-box">
        <div class="cover-area">
            <img id="coverDisplay" class="cover-img" src="">
            <label class="admin-only" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.5); padding:8px; border-radius:50%; color:white; cursor:pointer;">ğŸ“¸<input type="file" hidden onchange="uploadBranding('cover', this)"></label>
        </div>
        <div class="profile-area">
            <div style="position:relative;">
                <img id="profileDisplay" class="p-img" src="">
                <label class="admin-only" style="position:absolute; bottom:5px; right:0; background:rgba(0,0,0,0.5); padding:5px; border-radius:50%; color:white; cursor:pointer;">ğŸ“·<input type="file" hidden onchange="uploadBranding('profile', this)"></label>
            </div>
            <div>
                <h2 id="pageNameHeader" style="font-size: 17px; margin:0;" onclick="editPageName()">Emotion Community</h2>

                
                <p id="memberCount" style="font-size: 11px; color: gray;">0 Members</p>
            </div>
            <div id="statusArea" style="margin-left: auto;"></div>
        </div>
<div class="search-container" style="position: relative;">
    <div class="search-box">
        <span>ğŸ”</span>
        <input type="text" id="pageSearch" placeholder="Search page name..." onkeyup="searchPage()" autocomplete="off">
    </div>
    <div id="searchResults" style="position: absolute; width: 100%; background: white; z-index: 1000; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; max-height: 250px; overflow-y: auto; top: 45px;"></div>
</div>
    <div id="postBox" class="card admin-only">
        <textarea id="postText" rows="3" placeholder="á€˜á€¬á€á€½á€±á€á€±á€™á€»á€¾á€á€»á€„á€ºá€œá€² Senior..." style="width:100%; border:none; outline:none; font-size:15px; resize:none;"></textarea>
        <div id="mediaPreview" style="margin-top:10px; display:none; position:relative;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
            <label style="cursor:pointer; color:var(--p); font-size:13px; font-weight:bold;">ğŸ–¼ï¸ Media<input type="file" id="mediaInput" hidden multiple onchange="previewMedia(this)">
 </label>
            <button class="btn-main" id="btnPost" onclick="handlePost()">Post</button>
        </div>
    </div>
<div id="imgModal">
    <span class="modal-close" onclick="this.parentElement.style.display='none'">Ã—</span>
    <img id="modalImg" src="">
</div>

    <div id="feed"></div>
    <nav class="bottom-nav">
        <a href="user.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/1946/1946488.png"><span data-lang="nav_user">User</span>
        </a>

        <a href="chat.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/589/589708.png"><span data-lang="nav_chat">Chat</span>
        </a>
        <a href="live.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/4404/4404094.png"><span data-lang="nav_live">Live</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png"><span data-lang="nav_profile">Profile</span>
        </a>
    </nav>

<script>
    // --- Firebase & Keys ---
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const IMGBB_KEY = "C8d8d00185e973ebcafddd34f77a1176";
    const BUNNY_KEY = "a038d7e1-bf94-448b-b863c156422e-7e4a-4299";
    const BUNNY_STORAGE = "public-hospitals";
    const ADMIN_EMAIL = "uwinkyawdevelopbusinessco@gmail.com";

       // --- Auth Listener (Updated) ---
    auth.onAuthStateChanged(async user => {
        if (user) {
            // áá‹ Block á€…á€…á€ºá€™á€šá€º
            const blockCheck = await db.collection("blocked_users").doc(user.uid).get();
            if (blockCheck.exists) { 
                alert("Your account is blocked!"); 
                auth.signOut(); 
                return; 
            }
            
            // á‚á‹ á€¡á€á€¼á€±á€á€¶ Data á€á€½á€± Load á€œá€¯á€•á€ºá€™á€šá€º
            loadBranding(); 
            loadPosts(); 
            loadMembers(); 
            listenNoti();

            // áƒá‹ Status á€…á€…á€ºá€™á€šá€º (á€’á€«á€€ User á€Ÿá€¬ Admin á€œá€¬á€¸ Member á€œá€¬á€¸ á€á€½á€²á€•á€±á€¸á€™á€¾á€¬á€•á€«)
            checkStatus(user.uid);
            
        } else { 
            window.location.href = "login.html"; 
        }
    });


    function showAdmin() { document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block'); }
    function formatTime(ts) { if(!ts) return ""; return new Date(ts).toLocaleString(); }
// --- View System (Optimized for Senior) ---
const viewObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        // Post á€á€…á€ºá€á€¯á€€á€­á€¯ á…á€% á€€á€»á€±á€¬á€º á€™á€¼á€„á€ºá€›á€•á€¼á€®á€†á€­á€¯á€á€¬á€”á€²á€· view á€á€€á€ºá€™á€šá€º
        if (entry.isIntersecting) {
            const postId = entry.target.dataset.id;
            if (postId) {
                db.collection("page_posts").doc(postId).update({ 
                    views: firebase.firestore.FieldValue.increment(1) 
                }).catch(err => console.error("View update error:", err));
                
                // á€á€…á€ºá€á€«á€á€€á€ºá€•á€¼á€®á€¸á€›á€„á€º á€‘á€•á€ºá€™á€á€€á€ºá€¡á€±á€¬á€„á€º á€›á€•á€ºá€œá€­á€¯á€€á€ºá€™á€šá€º
                viewObserver.unobserve(entry.target);
            }
        }
    });
}, { 
    threshold: 0.5 
});
function loadPosts() {
    db.collection("page_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
        const feed = document.getElementById('feed');
        const uid = auth.currentUser.uid;

        snap.docChanges().forEach(change => {
            const d = change.doc.data(); const id = change.doc.id;
            const isOwnerOrDev = (d.uid === uid) || (auth.currentUser.email === ADMIN_EMAIL);

            if (change.type === "added") {
                const div = document.createElement('div'); div.className = "card"; div.id = `post-${id}`; div.dataset.id = id;
                
                let mediaHTML = "";
                // --- Senior á€›á€²á€· Media Logic á€€á€­á€¯ á€•á€¼á€„á€ºá€†á€„á€ºá€‘á€¬á€¸á€á€²á€·á€¡á€•á€­á€¯á€„á€ºá€¸ ---
                if (d.mediaUrls && d.mediaUrls.length > 0) {
                    if (d.mediaType === 'video') {
                        // Video á€–á€¼á€…á€ºá€›á€„á€º Video Player á€”á€²á€· á€•á€¼á€™á€šá€º
                        mediaHTML = `<video src="${d.mediaUrls[0]}" controls class="post-media" style="height:auto; max-height:400px;"></video>`;
                    } else {
                        // á€•á€¯á€¶á€–á€¼á€…á€ºá€›á€„á€º Grid á€”á€²á€·á€•á€¼á€•á€¼á€®á€¸ á€”á€¾á€­á€•á€ºá€›á€„á€º Modal á€•á€½á€„á€·á€ºá€¡á€±á€¬á€„á€º á€œá€¯á€•á€ºá€™á€šá€º
                        mediaHTML = `<div style="display:grid; grid-template-columns: repeat(${d.mediaUrls.length > 1 ? 2 : 1}, 1fr); gap:5px; margin-top:10px;">`;
                        d.mediaUrls.forEach(url => {
                            mediaHTML += `<img src="${url}" class="post-media" style="margin-top:0; height:150px; object-fit:cover; border-radius:8px; cursor:pointer;" onclick="openFullImg('${url}')">`;
                        });
                        mediaHTML += `</div>`;
                    }
                } else if (d.mediaUrl) { 
                    // á€’á€«á€€ Post á€¡á€Ÿá€±á€¬á€„á€ºá€¸á€á€½á€±á€¡á€á€½á€€á€º Logic (Optional)
                    mediaHTML = d.mediaType === 'video' ? `<video src="${d.mediaUrl}" controls class="post-media"></video>` : `<img src="${d.mediaUrl}" class="post-media" onclick="openFullImg('${d.mediaUrl}')">`;
                }

                div.innerHTML = `
                    <div style="font-size:12px; color:gray; margin-bottom:8px;">
                        <b>${d.author}</b> â€¢ <span id="v-${id}">${d.views || 0}</span> views <br>
                        <span class="time-label">${formatTime(d.createdAt)}</span>
                    </div>
                    <p style="white-space:pre-wrap;">${d.text}</p>
                    ${mediaHTML}
                    
                    <div class="interaction" id="int-${id}">
                        <span onclick="handleReact('${id}', 'likes')" style="cursor:pointer; color:${(d.likedBy || []).includes(uid) ? 'purple' : 'gray'}">ğŸ‘ <span id="l-${id}">${d.likes || 0}</span></span>
                        <span onclick="handleReact('${id}', 'hahas')" style="cursor:pointer; color:${(d.hahaedBy || []).includes(uid) ? 'orange' : 'gray'}">ğŸ˜† <span id="h-${id}">${d.hahas || 0}</span></span>
                        <span onclick="toggleC('${id}')" style="cursor:pointer;">ğŸ’¬ <span id="cc-${id}">${(d.comments || []).length}</span></span>
                        <span onclick="sharePost('${id}')" style="cursor:pointer; color:purple;">ğŸš€ Share</span>
                        ${isOwnerOrDev ? `
                            <span onclick="deleteAnythingWithCleanup('${id}')" style="color:red; cursor:pointer;">ğŸ—‘ï¸</span> 
                            <span onclick="togglePin('${id}', ${d.isPinned})" style="color:${d.isPinned ? 'red' : 'gray'}; cursor:pointer;">ğŸ“Œ</span>
                        ` : ''}
                    </div>
                    <div class="comment-box" id="cb-${id}">
                        <div id="cl-${id}"></div>
                        <div style="display:flex; margin-top:10px; gap:5px;">
                            <input type="text" id="cInput-${id}" placeholder="Comment..." style="flex:1; border-radius:15px; border:1px solid #ddd; padding:5px 10px; outline:none;">
                            <button onclick="addComment('${id}')" style="border:none; background:purple; color:white; border-radius:15px; padding:5px 12px;">Send</button>
                        </div>
                    </div>`;
                
                // Post á€¡á€á€…á€ºá€á€½á€± á€¡á€•á€±á€«á€ºá€€á€•á€±á€«á€ºá€–á€­á€¯á€· prepend á€á€¯á€¶á€¸á€á€¬ á€•á€­á€¯á€€á€±á€¬á€„á€ºá€¸á€•á€«á€á€šá€º
                feed.prepend(div); 
                viewObserver.observe(div);
                loadComments(id);
            }

            // --- á€”á€‚á€­á€¯ Logic á€¡á€á€­á€¯á€„á€ºá€¸ Reaction Update á€á€½á€± á€•á€¼á€”á€ºá€•á€«á€•á€«á€á€šá€º ---
            if (change.type === "modified") {
                const lEl = document.getElementById(`l-${id}`);
                const hEl = document.getElementById(`h-${id}`);
                const vEl = document.getElementById(`v-${id}`);
                if (lEl) lEl.innerText = d.likes || 0;
                if (hEl) hEl.innerText = d.hahas || 0;
                if (vEl) vEl.innerText = d.views || 0;

                const intBox = document.getElementById(`int-${id}`);
                if (intBox) {
                    const pinBtn = intBox.querySelector('span:last-child');
                    if(pinBtn && isOwnerOrDev) pinBtn.style.color = d.isPinned ? 'red' : 'gray';
                }
            }
        });
    });
}

async function handlePost() {
    const text = document.getElementById('postText').value.trim();
    const files = Array.from(document.getElementById('mediaInput').files);
    const btn = document.getElementById('btnPost');
    
    if(!text && files.length === 0) return;

    btn.disabled = true; 
    btn.innerText = "Uploading Media...";

    try {
        const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
        const authorName = userDoc.data()?.requestedPageName || auth.currentUser.displayName || "Admin";

        // Senior á€œá€­á€¯á€á€»á€„á€ºá€á€²á€· Parallel Upload Logic (Promise.all)
        const uploadPromises = files.map(async (file) => {
            if (file.type.startsWith('video/')) {
                const fName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                const res = await fetch(`https://sg.storage.bunnycdn.com/${BUNNY_STORAGE}/${fName}`, {
                    method: 'PUT',
                    headers: { 'AccessKey': BUNNY_KEY },
                    body: file
                });
                if (res.ok) return `https://${BUNNY_STORAGE}.b-cdn.net/${fName}`;
            } else {
                const fd = new FormData();
                fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                    method: 'POST',
                    body: fd
                });
                const data = await res.json();
                if (data.success) return data.data.url;
            }
            return null;
        });

        // á€•á€¯á€¶á€¡á€¬á€¸á€œá€¯á€¶á€¸ á€á€…á€ºá€•á€¼á€­á€¯á€„á€ºá€”á€€á€ºá€á€€á€ºá€á€½á€¬á€¸á€¡á€±á€¬á€„á€º á€…á€±á€¬á€„á€·á€ºá€™á€šá€º
        const mediaUrls = (await Promise.all(uploadPromises)).filter(Boolean);
        
        // Video á€•á€«á€á€œá€¬á€¸ á€…á€…á€ºá€™á€šá€º (mediaType á€á€á€ºá€™á€¾á€á€ºá€›á€”á€º)
        const hasVideo = files.some(f => f.type.startsWith('video/'));

        await db.collection("page_posts").add({ 
            uid: auth.currentUser.uid, 
            author: authorName,
            text: text, 
            mediaUrls: mediaUrls, // Array á€¡á€”á€±á€”á€²á€· á€á€­á€™á€ºá€¸á€™á€šá€º
            mediaType: hasVideo ? 'video' : 'image', 
            likes: 0, 
            likedBy: [], 
            hahas: 0, 
            hahaedBy: [], 
            comments: [], 
            views: 0, 
            isPinned: 0, 
            createdAt: Date.now() 
        });

        document.getElementById('postText').value = ""; 
        cancelMedia();
        alert("Post á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€® Senior!");

    } catch (error) {
        console.error("Post Error:", error);
        alert("Upload á€œá€¯á€•á€ºá€›á€¬á€™á€¾á€¬ á€¡á€™á€¾á€¬á€¸á€¡á€šá€½á€„á€ºá€¸ á€›á€¾á€­á€á€½á€¬á€¸á€•á€«á€á€šá€º");
    } finally {
        btn.disabled = false; 
        btn.innerText = "Post";
    }
}


// Preview á€•á€¼á€á€²á€·á€”á€±á€›á€¬á€™á€¾á€¬ á€•á€¯á€¶á€¡á€™á€»á€¬á€¸á€€á€¼á€®á€¸á€•á€¼á€–á€­á€¯á€· á€•á€¼á€„á€ºá€‘á€¬á€¸á€•á€«á€á€šá€º
function previewMedia(i) {
    const files = Array.from(i.files);
    const b = document.getElementById('mediaPreview'); 
    if(files.length === 0) return;
    if(files.length > 10) { alert("á€•á€¯á€¶ áá€ á€•á€¯á€¶á€‘á€€á€º á€•á€­á€¯á€á€„á€ºá€œá€­á€¯á€·á€™á€›á€•á€«"); i.value=""; return; }
    
    b.style.display = "block";
    b.innerHTML = `<div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;"></div>`;
    const grid = b.querySelector('div');

    files.forEach(f => {
        const url = URL.createObjectURL(f);
        grid.innerHTML += f.type.startsWith('video') 
            ? `<video src="${url}" style="width:100%; height:80px; object-fit:cover; border-radius:5px;"></video>` 
            : `<img src="${url}" style="width:100%; height:80px; object-fit:cover; border-radius:5px;">`;
    });
    
    b.innerHTML += `<div onclick="cancelMedia()" style="position:absolute; top:-10px; right:-10px; background:red; color:white; border-radius:50%; width:25px; height:25px; text-align:center; line-height:23px; cursor:pointer;">Ã—</div>`;
}

    function cancelMedia() { 
        document.getElementById('mediaInput').value = ""; 
        document.getElementById('mediaPreview').innerHTML = "";
        document.getElementById('mediaPreview').style.display = 'none'; 
    }

async function handleReact(postId, type) {
    try {
        const ref = db.collection("page_posts").doc(postId);
        const uid = auth.currentUser.uid;
        const snap = await ref.get();
        
        if (!snap.exists) return;
        const d = snap.data();

        // á€˜á€šá€º reaction á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸á€œá€²á€†á€­á€¯á€á€¬ á€á€½á€²á€á€¼á€¬á€¸á€™á€šá€º
        const isLike = (type === 'likes');
        const field = isLike ? 'likedBy' : 'hahaedBy';
        const countField = isLike ? 'likes' : 'hahas';
        
        // User á€€ React á€•á€±á€¸á€•á€¼á€®á€¸á€á€¬á€¸á€œá€¬á€¸ á€…á€…á€ºá€™á€šá€º
        const hasReacted = (d[field] || []).includes(uid);

        if (hasReacted) {
            // á€•á€±á€¸á€‘á€¬á€¸á€•á€¼á€®á€¸á€á€¬á€¸á€†á€­á€¯á€›á€„á€º á€•á€¼á€”á€ºá€–á€¼á€¯á€á€ºá€™á€šá€º (Decrement)
            await ref.update({ 
                [field]: firebase.firestore.FieldValue.arrayRemove(uid), 
                [countField]: firebase.firestore.FieldValue.increment(-1) 
            });
        } else {
            // á€™á€•á€±á€¸á€›á€á€±á€¸á€›á€„á€º á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€™á€šá€º (Increment)
            await ref.update({ 
                [field]: firebase.firestore.FieldValue.arrayUnion(uid), 
                [countField]: firebase.firestore.FieldValue.increment(1) 
            });
            
            // Post á€•á€­á€¯á€„á€ºá€›á€¾á€„á€ºá€†á€® Noti á€•á€­á€¯á€·á€™á€šá€º
            sendNoti(`${auth.currentUser.displayName} reacted to your post`);
        }
    } catch (error) {
        console.error("Reaction Error:", error);
    }
}

async function addComment(postId) {
    const val = document.getElementById(`cInput-${postId}`).value.trim();
    if (!val) return;

    await db.collection("page_posts").doc(postId).collection("comments").add({
        uid: auth.currentUser.uid,
        author: auth.currentUser.displayName || "User",
        text: val,
        createdAt: Date.now()
    });

    document.getElementById(`cInput-${postId}`).value = "";
}
function loadComments(postId) {
    db.collection("page_posts").doc(postId).collection("comments")
      .orderBy("createdAt", "asc")
      .onSnapshot(snap => {
        const list = document.getElementById(`cl-${postId}`);
        if (!list) return;
        list.innerHTML = "";
        
        const countBox = document.getElementById(`cc-${postId}`);
        if (countBox) countBox.innerText = snap.size;

        snap.forEach(doc => {
            const c = doc.data();
            const cid = doc.id;
            const uid = auth.currentUser.uid;
            
            list.innerHTML += `
                <div class="c-item">
                    <b>${c.author}</b>: ${c.text}
                    <div style="font-size:11px; margin-top:5px; display:flex; gap:12px;">
                        <span onclick="reactComment('${postId}', '${cid}', 'likes')" 
                              style="cursor:pointer; color:${(c.likedBy || []).includes(uid) ? 'purple' : 'gray'}">
                            ğŸ‘ ${c.likes || 0}
                        </span>
                        <span onclick="reactComment('${postId}', '${cid}', 'hahas')" 
                              style="cursor:pointer; color:${(c.hahaedBy || []).includes(uid) ? 'orange' : 'gray'}">
                            ğŸ˜† ${c.hahas || 0}
                        </span>
                    </div>
                </div>`;
        });
    });
}

    async function reactComment(postId, commentId, type) {
    const ref = db.collection("page_posts")
        .doc(postId)
        .collection("comments")
        .doc(commentId);

    const snap = await ref.get();
    const d = snap.data();
    const uid = auth.currentUser.uid;

    const field = type === "likes" ? "likedBy" : "hahaedBy";
    const countField = type === "likes" ? "likes" : "hahas";

    if ((d[field] || []).includes(uid)) {
        await ref.update({
            [field]: firebase.firestore.FieldValue.arrayRemove(uid),
            [countField]: firebase.firestore.FieldValue.increment(-1)
        });
    } else {
        await ref.update({
            [field]: firebase.firestore.FieldValue.arrayUnion(uid),
            [countField]: firebase.firestore.FieldValue.increment(1)
        });
    }
}
  async function sharePost(id) {
        const snap = await db.collection("page_posts").doc(id).get();
        await db.collection("health_posts").add({ ...snap.data(), uid: auth.currentUser.uid, isShared: true, createdAt: Date.now() });
        alert("Shared to Profile Successfully!");
    }

    // áá‹ á€›á€¾á€¬á€–á€½á€±á€•á€¼á€®á€¸ á€…á€¬á€›á€„á€ºá€¸á€‘á€¯á€á€ºá€•á€¼á€™á€Šá€·á€º Function
async function searchPage() {
    const query = document.getElementById('pageSearch').value.toLowerCase().trim();
    const resBox = document.getElementById('searchResults');
    
    if (!query) { 
        resBox.style.display = "none"; 
        return; 
    }

    const snap = await db.collection("users")
                   .where("isPremium", "==", true)
                   .get();

    resBox.innerHTML = ""; 
    let hasResults = false;

    snap.forEach(doc => {
        const data = doc.data();
        const pageName = data.requestedPageName || "Unnamed Page";
        
        // á€›á€­á€¯á€€á€ºá€œá€­á€¯á€€á€ºá€á€²á€·á€…á€¬á€œá€¯á€¶á€¸á€”á€²á€· á€†á€„á€ºá€á€°á€á€¬ á€›á€¾á€­á€™á€›á€¾á€­ á€…á€…á€ºá€™á€šá€º
        if (pageName.toLowerCase().includes(query)) {
            hasResults = true;
            resBox.style.display = "block";
            
            // List item á€á€…á€ºá€á€¯á€á€»á€„á€ºá€¸á€…á€®á€€á€­á€¯ á€á€Šá€ºá€†á€±á€¬á€€á€ºá€™á€šá€º
            const item = document.createElement('div');
            item.className = "search-item";
            item.style = "padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 10px;";
            item.innerHTML = `<span>ğŸ“„</span> <b>${pageName}</b>`;
            
            // á€”á€¾á€­á€•á€ºá€œá€­á€¯á€€á€ºá€›á€„á€º á€¡á€²á€·á€’á€® Page á€€á€­á€¯ á€á€½á€¬á€¸á€™á€šá€·á€º event á€‘á€Šá€·á€ºá€™á€šá€º
            item.onclick = () => {
                viewOtherPage(doc.id);
            };
            
            resBox.appendChild(item);
        }
    });

    if (!hasResults) resBox.style.display = "none";
}

// á‚á‹ á€›á€½á€±á€¸á€á€»á€šá€ºá€œá€­á€¯á€€á€ºá€á€±á€¬ Page á€†á€®á€á€­á€¯á€· á€á€½á€¬á€¸á€™á€Šá€·á€º Function
function viewOtherPage(pageOwnerId) {
    // Search Box á€€á€­á€¯ á€•á€¼á€”á€ºá€•á€­á€á€ºá€™á€šá€º
    document.getElementById('searchResults').style.display = "none";
    document.getElementById('pageSearch').value = "";
    
    window.location.href = `profile.html?id=${pageOwnerId}`;
}

// Search Box á€¡á€•á€¼á€„á€ºá€˜á€€á€ºá€€á€­á€¯ á€”á€¾á€­á€•á€ºá€›á€„á€º List á€•á€­á€á€ºá€á€½á€¬á€¸á€¡á€±á€¬á€„á€º á€œá€¯á€•á€ºá€™á€šá€º
document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-container')) {
        document.getElementById('searchResults').style.display = "none";
    }
});


    async function loadBranding() {
        const uid = auth.currentUser.uid;
        const isAdmin = (auth.currentUser.email === ADMIN_EMAIL);

        if (isAdmin) {
            // Developer á€¡á€á€½á€€á€º Main Info á€€á€­á€¯ á€†á€½á€²á€‘á€¯á€á€ºá€™á€šá€º
            db.collection("page_info").doc("main").onSnapshot(d => {
                if(d.exists){
                    document.getElementById('coverDisplay').src = d.data().cover || 'https://via.placeholder.com/400x180';
                    document.getElementById('profileDisplay').src = d.data().profile || 'https://via.placeholder.com/100';
                    document.getElementById('pageNameHeader').innerText = d.data().pageTitle || "Main Community";
                }
            });
        } else {
            // á€›á€­á€¯á€¸á€›á€­á€¯á€¸ User Page Admin á€¡á€á€½á€€á€º á€á€°á€·á€›á€²á€· Profile á€€á€­á€¯ á€†á€½á€²á€‘á€¯á€á€ºá€™á€šá€º
            db.collection("users").doc(uid).onSnapshot(d => {
                if(d.exists){
                    const data = d.data();
                    document.getElementById('coverDisplay').src = data.cover || 'https://via.placeholder.com/400x180';
                    document.getElementById('profileDisplay').src = data.profile || 'https://via.placeholder.com/100';
                    document.getElementById('pageNameHeader').innerText = data.requestedPageName || "My Community";
                }
            });
        }
    }


    // --- User Role & Admin Status Check ---
    async function checkStatus(uid) {
        try {
            const uDoc = await db.collection("users").doc(uid).get();
            const userData = uDoc.data();
            
            // Member á€–á€¼á€…á€ºá€™á€–á€¼á€…á€º á€¡á€›á€„á€ºá€…á€…á€ºá€™á€šá€º
            const isJoined = (await db.collection("page_members").doc(uid).get()).exists;
            const area = document.getElementById('statusArea');

            if (!isJoined) {
                // á€™ join á€›á€á€±á€¸á€›á€„á€º Join/Create á€•á€¼á€™á€šá€º
                area.innerHTML = `
                    <button class="btn-main" onclick="joinPage()">Join</button> 
                    <button class="btn-main" style="background:#444;" onclick="startPageCreation()">Create</button>`;
            } else {
                // Join á€•á€¼á€®á€¸á€á€¬á€¸á€á€°á€á€½á€±á€‘á€²á€™á€¾á€¬ Role á€á€½á€²á€™á€šá€º
                if (userData?.isPremium === true) {
                    
                    area.innerHTML = `<span style="color:var(--p); font-weight:bold; font-size:12px;">ğŸ‘‘ Page Admin</span>`;
                    showAdmin(); 
                } else if (userData?.isRequestPending === true) {
                    // Request á€á€„á€ºá€‘á€¬á€¸á€á€¯á€”á€ºá€¸á€á€°
                    area.innerHTML = `<small style="color:orange;">â³ Pending Approval...</small>`;
                } else {
                    // á€›á€­á€¯á€¸á€›á€­á€¯á€¸ Member
                    area.innerHTML = `<small style="color:green;">âœ“ Joined</small>`;
                }
            }
        } catch (error) {
            console.error("Status Check Error:", error);
        }
    }

    function showAdmin() {
        document.querySelectorAll('.admin-only').forEach(e => {
            e.style.display = 'block';
        });
        console.log("Admin UI Unlocked for User");
    }


    async function startPageCreation() {
        const name = prompt("Page Name:");
        if (name && name.length > 2) {
            await db.collection("users").doc(auth.currentUser.uid).set({ isRequestPending: true, requestedPageName: name }, { merge: true });
            await db.collection("admin_requests").add({ uid: auth.currentUser.uid, email: auth.currentUser.email, requestedPageName: name, status: "pending", time: Date.now() });
            alert("Requested Successfully!"); location.reload();
        }
    }
async function deleteAnythingWithCleanup(id) {
    if (!confirm("á€’á€® Post á€€á€­á€¯ á€–á€»á€€á€ºá€™á€¾á€¬ á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) return;
    
    try {
        const ref = db.collection("page_posts").doc(id);
        const snap = await ref.get();
        if (!snap.exists) return;
        const d = snap.data();

        // áá‹ Bunny CDN á€€ Media (Array) á€€á€­á€¯ á€¡á€€á€¯á€”á€ºá€œá€­á€¯á€€á€ºá€–á€»á€€á€ºá€™á€šá€º
        if (d.mediaUrls && Array.isArray(d.mediaUrls)) {
            for (let url of d.mediaUrls) {
                if (url.includes('b-cdn.net')) {
                    const fileName = url.split('/').pop();
                    try {
                        await fetch(`https://sg.storage.bunnycdn.com/${BUNNY_STORAGE}/${fileName}`, { 
                            method: 'DELETE', 
                            headers: { 'AccessKey': BUNNY_KEY } 
                        });
                    } catch (err) {
                        console.error("Bunny Delete Error:", err);
                    }
                }
            }
        }
        
        // á‚á‹ Firestore á€€ Post á€€á€­á€¯ á€–á€»á€€á€ºá€™á€šá€º
        await ref.delete();
        alert("Deleted Successfully!");

        // UI á€€á€”á€± á€á€»á€€á€ºá€á€»á€„á€ºá€¸á€–á€šá€ºá€‘á€¯á€á€ºá€™á€šá€º
        const postEl = document.getElementById(`post-${id}`);
        if (postEl) postEl.remove();

    } catch (e) {
        console.error("Delete error:", e);
        alert("á€–á€»á€€á€ºá€œá€­á€¯á€·á€™á€›á€•á€« (Permission Denied)");
    }
}


async function togglePin(id, curStatus) {
    try {
        const newStatus = (curStatus == 1 || curStatus === true) ? 0 : 1;
        await db.collection("page_posts").doc(id).update({ 
            isPinned: newStatus 
        });
    } catch (e) {
        console.error("Pin error:", e);
    }
}

    async function joinPage() { await db.collection("page_members").doc(auth.currentUser.uid).set({ uid: auth.currentUser.uid, joinedAt: Date.now() }); location.reload(); }
    function toggleC(id) { const b = document.getElementById(`cb-${id}`); b.style.display = b.style.display==='block'?'none':'block'; }
    function loadMembers() { db.collection("page_members").onSnapshot(s => document.getElementById('memberCount').innerText = `${s.size} Members`); }
    async function sendNoti(msg) { await db.collection("notifications").add({ receiverId: ADMIN_EMAIL, message: msg, sender: auth.currentUser.displayName || "User", createdAt: Date.now(), status: "unread" }); }
    function listenNoti() {
    if(!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) return;
    
    db.collection("notifications")
      .where("receiverId", "==", ADMIN_EMAIL)
      .where("status", "==", "unread")
      .onSnapshot(s => {
        s.docChanges().forEach(async c => { 
            if(c.type === "added") { 
                const data = c.doc.data();
                // alert á€¡á€…á€¬á€¸ console á€™á€¾á€¬á€•á€² á€¡á€›á€„á€ºá€•á€¼á€€á€¼á€Šá€·á€ºá€•á€«
                console.log("New Notification:", data.message);
                
                // notification á€€á€­á€¯ á€á€»á€€á€ºá€á€»á€„á€ºá€¸ read á€œá€¯á€•á€ºá€•á€…á€ºá€•á€« (á€’á€«á€™á€¾ á€‘á€•á€ºá€á€«á€‘á€•á€ºá€á€« á€™á€•á€±á€«á€ºá€™á€¾á€¬)
                await db.collection("notifications").doc(c.doc.id).update({ status: "read" }); 
            }
        });
    });
}
async function editPageName() {
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    if (userDoc.data()?.isPremium) {
        const newName = prompt("Enter New Page Name:", document.getElementById('pageNameHeader').innerText);
        if (newName && newName.length > 2) {
            await db.collection("users").doc(auth.currentUser.uid).update({ requestedPageName: newName });
            alert("Page Name Updated!");
        }
    }
}
     // --- Branding Upload Logic (Senior Edition) ---
    async function uploadBranding(type, input) {
        const file = input.files[0];
        if (!file) return;

        const btnLabel = input.parentElement;
        const originalText = btnLabel.innerHTML;
        btnLabel.innerHTML = "â³"; // Upload á€á€„á€ºá€”á€±á€…á€‰á€º icon á€•á€¼á€±á€¬á€„á€ºá€¸á€‘á€¬á€¸á€™á€šá€º

        try {
            // áá‹ ImgBB á€€á€­á€¯ á€¡á€›á€„á€º Upload á€á€„á€ºá€™á€šá€º
            const fd = new FormData();
            fd.append('image', file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { 
                method: 'POST', 
                body: fd 
            });
            const d = await res.json();
            
            if (d.success) {
                const url = d.data.url;
                const uid = auth.currentUser.uid;
                const isDeveloper = (auth.currentUser.email === ADMIN_EMAIL);

                // á‚á‹ Database á€‘á€²á€™á€¾á€¬ Developer á€œá€¬á€¸ User á€œá€¬á€¸á€á€½á€²á€•á€¼á€®á€¸ á€á€­á€™á€ºá€¸á€™á€šá€º
                if (isDeveloper) {
                    // Senior (Developer) á€†á€­á€¯á€›á€„á€º Main Branding á€€á€­á€¯ á€•á€¼á€„á€ºá€™á€šá€º
                    await db.collection("page_info").doc("main").set({ [type]: url }, { merge: true });
                } else {
                    // Page Admin (User) á€†á€­á€¯á€›á€„á€º á€á€°á€·á€›á€²á€· User Document á€‘á€²á€™á€¾á€¬ á€á€­á€™á€ºá€¸á€™á€šá€º
                    await db.collection("users").doc(uid).update({ [type]: url });
                }
                alert("Branding Updated Successfully! âœ¨");
                location.reload(); // á€•á€¯á€¶á€¡á€á€…á€ºá€•á€±á€«á€ºá€œá€¬á€¡á€±á€¬á€„á€º Page á€€á€­á€¯ Refresh á€œá€¯á€•á€ºá€™á€šá€º
            }
        } catch (e) {
            console.error("Upload Error:", e);
            alert("Upload failed! Please try again.");
        } finally {
            btnLabel.innerHTML = originalText;
        }
    }
// á€•á€¯á€¶á€€á€­á€¯ Full Screen á€•á€¼á€á€›á€”á€º Function
function openFullImg(url) {
    const modal = document.getElementById('imgModal');
    if (modal) {
        document.getElementById('modalImg').src = url;
        modal.style.display = 'flex';
    } else {
        // Modal á€™á€†á€±á€¬á€€á€ºá€›á€á€±á€¸á€›á€„á€º Alert á€”á€²á€·á€•á€² á€•á€¼á€•á€±á€¸á€‘á€¬á€¸á€™á€šá€º
        window.open(url, '_blank');
    }
}

</script>
</body>
</html>

