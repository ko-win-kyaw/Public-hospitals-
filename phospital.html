<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Page - Senior Elite</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root { --purple: #800080; --bg: #f0f2f5; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); padding-bottom: 80px; }

        /* Branding UI */
        .header-container { background: white; position: relative; border-radius: 0 0 20px 20px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .cover-box { width: 100%; height: 200px; background: #ddd; position: relative; }
        .cover-photo { width: 100%; height: 100%; object-fit: cover; }
        .profile-section { padding: 0 15px; margin-top: -60px; display: flex; align-items: flex-end; gap: 15px; padding-bottom: 15px; position: relative; }
        .admin-img-box { position: relative; width: 110px; height: 110px; }
        .admin-img { width: 110px; height: 110px; border-radius: 50%; border: 4px solid white; background: #eee; object-fit: cover; }
        
        /* Edit Badge */
        .btn-edit-badge { position: absolute; background: rgba(0,0,0,0.6); color: white; padding: 8px; border-radius: 50%; cursor: pointer; bottom: 5px; right: 5px; font-size: 14px; z-index: 10; border: 2px solid white; }

        /* Media Post UI */
        .card { background: white; margin: 12px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .post-media { width: 100%; border-radius: 10px; margin-top: 10px; max-height: 450px; object-fit: cover; background: #000; }
        
        .interaction-bar { display: flex; justify-content: space-between; margin-top: 12px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .react-btn { cursor: pointer; background: #f0f2f5; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; }
        
        .admin-only { display: none; }
        .btn-main { background: var(--purple); color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        
        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; font-size: 10px; }
        .nav-item img { width: 22px; height: 22px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="cover-box">
            <img id="coverDisplay" class="cover-photo" src="https://via.placeholder.com/800x200">
            <label class="btn-edit-badge admin-only">üì∏<input type="file" hidden onchange="updateBranding('cover', this)"></label>
        </div>
        <div class="profile-section">
            <div class="admin-img-box">
                <img id="profileDisplay" class="admin-img" src="https://via.placeholder.com/150">
                <label class="btn-edit-badge admin-only">üì∑<input type="file" hidden onchange="updateBranding('profile', this)"></label>
            </div>
            <div class="page-meta">
                <h2 id="pageTitle" style="font-size: 20px;">Emotion Community</h2>
                <p id="memberCount" style="font-size: 12px; color: gray;">0 Members</p>
            </div>
            <div id="authArea" style="margin-left: auto;"></div>
        </div>
    </div>

    <div id="adminPostBox" class="card admin-only" style="border-top: 4px solid var(--purple);">
        <textarea id="postContent" rows="3" placeholder="·Äò·Ä¨·Äê·ÄΩ·Ä±·Äù·Ä±·Äô·Äª·Äæ·ÄÅ·Äª·ÄÑ·Ä∫·Äú·Ä≤ Senior..." style="width:100%; border:none; outline:none; font-size:16px; resize:none; background:#f9f9f9; padding:10px; border-radius:8px;"></textarea>
        <div id="mediaPreview" style="margin-top:10px; display:none; position:relative;"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
            <label style="cursor:pointer; color:var(--purple); font-weight:bold; font-size:14px;">üñºÔ∏è Media (Max 30MB) <input type="file" id="mediaInput" hidden onchange="previewMedia(this)"></label>
            <button class="btn-main" id="btnPost" onclick="handlePostUpload()">Post</button>
        </div>
    </div>

    <div id="pageFeed"></div>

    <nav class="bottom-nav">
        <a href="user.html" class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946488.png">User</a>
        <a href="chat.html" class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/589/589708.png">Chat</a>
        <a href="live.html" class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/4404/4404094.png">Live</a>
        <a href="profile.html" class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png">Profile</a>
    </nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const IMGBB_KEY = "C8d8d00185e973ebcafddd34f77a1176";
    let currentUser = null;

    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            loadBranding();
            checkAdminStatus();
            loadPosts();
            loadMembersCount();
        } else { window.location.href = "login.html"; }
    });

    // Branding & Edit Logic
    async function updateBranding(type, input) {
        const file = input.files[0];
        if(!file) return;
        const url = await uploadFile(file);
        if(url) {
            await db.collection("page_info").doc("main").set({ [type]: url }, { merge: true });
            alert("Updated!");
        }
    }

    async function uploadFile(file) {
        const fd = new FormData(); fd.append('image', file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
        const d = await res.json();
        return d.success ? d.data.url : null;
    }

    function loadBranding() {
        db.collection("page_info").doc("main").onSnapshot(doc => {
            if(doc.exists) {
                const d = doc.data();
                if(d.cover) document.getElementById('coverDisplay').src = d.cover;
                if(d.profile) document.getElementById('profileDisplay').src = d.profile;
            }
        });
    }

    // Status & Approval Logic
    async function checkAdminStatus() {
        const userDoc = await db.collection("users").doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        const isJoined = (await db.collection("page_members").doc(currentUser.uid).get()).exists;

        if (userData.isPremium) {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        }

        const area = document.getElementById('authArea');
        if (!isJoined) {
            area.innerHTML = `<button class="btn-main" onclick="joinPage()">Join</button> 
                             <button class="btn-main" style="background:#444; margin-left:5px;" onclick="requestAdmin()">Create</button>`;
        } else if (userData.isRequestPending) {
            area.innerHTML = `<span style="font-size:11px; color:orange; font-weight:bold;">Waiting Approval...</span>`;
        }
    }

    async function requestAdmin() {
        await db.collection("users").doc(currentUser.uid).update({ isRequestPending: true });
        await db.collection("admin_requests").doc(currentUser.uid).set({
            uid: currentUser.uid, name: currentUser.displayName, time: Date.now(), status: "pending"
        });
        alert("Developer ·Äë·Ä∂·Äû·Ä≠·ÄØ·Ä∑ ·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äë·Ä¨·Ä∏·Äï·Ä´·Äû·Ää·Ä∫ Senior!");
        location.reload();
    }

    async function joinPage() {
        await db.collection("page_members").doc(currentUser.uid).set({ uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL });
        location.reload();
    }

    // Media Logic
    function previewMedia(input) {
        const file = input.files[0];
        if(file.size > 30 * 1024 * 1024) return alert("30MB ·Äë·ÄÄ·Ä∫·Äô·ÄÄ·Äª·Ä±·Ä¨·Ä∫·Äõ·Äï·Ä´!");
        const box = document.getElementById('mediaPreview');
        box.style.display = "block";
        box.innerHTML = file.type.startsWith('video') ? `<video src="${URL.createObjectURL(file)}" style="width:100%; border-radius:10px;" controls></video>` : `<img src="${URL.createObjectURL(file)}" style="width:100%; border-radius:10px;">`;
    }

    async function handlePostUpload() {
        const text = document.getElementById('postContent').value.trim();
        const file = document.getElementById('mediaInput').files[0];
        const btn = document.getElementById('btnPost');
        if(!text && !file) return;

        btn.disabled = true; btn.innerText = "Posting...";
        let mediaUrl = file ? await uploadFile(file) : "";

        await db.collection("page_posts").add({
            text, mediaUrl, author: "Admin", createdAt: Date.now(), likes: 0, hahas: 0, isPinned: false
        });
        location.reload();
    }

    function loadPosts() {
        db.collection("page_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
            const feed = document.getElementById('pageFeed');
            snap.docChanges().forEach(change => {
                const d = change.doc.data();
                const id = change.doc.id;
                if (change.type === "added") {
                    const div = document.createElement('div');
                    div.className = "card";
                    div.id = `post-${id}`;
                    div.style.borderLeft = d.isPinned ? "5px solid var(--purple)" : "none";
                    renderPost(div, d, id);
                    feed.appendChild(div);
                } else if (change.type === "modified") {
                    renderPost(document.getElementById(`post-${id}`), d, id);
                } else if (change.type === "removed") {
                    document.getElementById(`post-${id}`).remove();
                }
            });
        });
    }

    function renderPost(el, d, id) {
        const isAdmin = document.getElementById('adminPostBox').style.display === "block";
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b>Admin</b> <small style="color:gray;">${new Date(d.createdAt).toLocaleTimeString()}</small>
            </div>
            <p style="margin-top:10px; white-space:pre-wrap;">${d.text}</p>
            ${d.mediaUrl ? `<img src="${d.mediaUrl}" class="post-media">` : ''}
            <div class="interaction-bar">
                <div style="display:flex; gap:10px;">
                    <span class="react-btn" onclick="react('${id}', 'likes')">üëç ${d.likes || 0}</span>
                    <span class="react-btn" onclick="react('${id}', 'hahas')">üòÜ ${d.hahas || 0}</span>
                </div>
                ${isAdmin ? `
                    <div>
                        <span onclick="togglePin('${id}', ${d.isPinned})" style="cursor:pointer; margin-right:10px;">${d.isPinned ? 'üìå Unpin' : 'üìç Pin'}</span>
                        <span onclick="deletePost('${id}')" style="color:red; cursor:pointer;">üóëÔ∏è Delete</span>
                    </div>
                ` : ''}
            </div>
        `;
    }

    async function react(id, type) {
        const ref = db.collection("page_posts").doc(id);
        db.runTransaction(async t => {
            const doc = await t.get(ref);
            t.update(ref, { [type]: (doc.data()[type] || 0) + 1 });
        });
    }

    async function deletePost(id) { if(confirm("Delete this post?")) await db.collection("page_posts").doc(id).delete(); }
    async function togglePin(id, current) { await db.collection("page_posts").doc(id).update({ isPinned: !current }); location.reload(); }
    function loadMembersCount() { db.collection("page_members").onSnapshot(s => document.getElementById('memberCount').innerText = `${s.size} Members`); }
</script>
</body>
</html>
