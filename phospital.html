<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Page - Senior Final Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        :root { --p: #800080; --bg: #f0f2f5; }
        body { background: var(--bg); margin: 0; font-family: sans-serif; padding-bottom: 70px; }
        .header-box { background: white; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding-bottom: 12px; }
        .cover-area { width: 100%; height: 180px; background: #ddd; position: relative; }
        .cover-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-area { padding: 15px; margin-top: -50px; display: flex; align-items: flex-end; gap: 12px; }
        .p-img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; object-fit: cover; background: #eee; }
        .card { background: white; margin: 12px; padding: 15px; border-radius: 12px; position: relative; }
        .post-media { width: 100%; border-radius: 8px; margin-top: 10px; background: #000; }
        .admin-only { display: none; }
        .interaction { display: flex; justify-content: space-around; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; font-size: 13px; font-weight: bold; }
        .btn-main { background: var(--p); color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; }
        
        .search-container { margin: 10px 15px; position: relative; }
        .search-box { display: flex; background: #f0f2f5; border-radius: 20px; padding: 8px 15px; border: 1px solid #ddd; align-items: center; }
        .search-box input { border: none; outline: none; flex: 1; background: transparent; padding-left: 5px; }
        #searchResults { position: absolute; width: 100%; background: white; z-index: 100; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); top: 45px; display: none; }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

        .comment-box { margin-top: 10px; border-top: 1px solid #eee; display: none; }
        .c-item { background: #f0f2f5; padding: 10px; border-radius: 12px; margin-top: 8px; font-size: 13px; }
        .time-label { font-size: 10px; color: #999; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="header-box">
        <div class="cover-area">
            <img id="coverDisplay" class="cover-img" src="">
            <label class="admin-only" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.5); padding:8px; border-radius:50%; color:white; cursor:pointer;">üì∏<input type="file" hidden onchange="uploadBranding('cover', this)"></label>
        </div>
        <div class="profile-area">
            <div style="position:relative;">
                <img id="profileDisplay" class="p-img" src="">
                <label class="admin-only" style="position:absolute; bottom:5px; right:0; background:rgba(0,0,0,0.5); padding:5px; border-radius:50%; color:white; cursor:pointer;">üì∑<input type="file" hidden onchange="uploadBranding('profile', this)"></label>
            </div>
            <div>
                <h2 id="pageNameHeader" style="font-size: 17px; margin:0;">Emotion Community</h2>
                <p id="memberCount" style="font-size: 11px; color: gray;">0 Members</p>
            </div>
            <div id="statusArea" style="margin-left: auto;"></div>
        </div>

        <div class="search-container">
            <div class="search-box"><span>üîç</span><input type="text" id="pageSearch" placeholder="Search page name..." onkeyup="searchPage()"></div>
            <div id="searchResults"></div>
        </div>
    </div>

    <div id="postBox" class="card admin-only">
        <textarea id="postText" rows="3" placeholder="·Äò·Ä¨·Äê·ÄΩ·Ä±·Äù·Ä±·Äô·Äª·Äæ·ÄÅ·Äª·ÄÑ·Ä∫·Äú·Ä≤ Senior..." style="width:100%; border:none; outline:none; font-size:15px; resize:none;"></textarea>
        <div id="mediaPreview" style="margin-top:10px; display:none; position:relative;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
            <label style="cursor:pointer; color:var(--p); font-size:13px; font-weight:bold;">üñºÔ∏è Media <input type="file" id="mediaInput" hidden onchange="previewMedia(this)"></label>
            <button class="btn-main" id="btnPost" onclick="handlePost()">Post</button>
        </div>
    </div>

    <div id="feed"></div>

<script>
    // --- Firebase & Keys ---
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const IMGBB_KEY = "C8d8d00185e973ebcafddd34f77a1176";
    const BUNNY_KEY = "a038d7e1-bf94-448b-b863c156422e-7e4a-4299";
    const BUNNY_STORAGE = "public-hospitals";
    const ADMIN_EMAIL = "uwinkyawdevelopbusinessco@gmail.com";

    // --- Auth Listener ---
    auth.onAuthStateChanged(async user => {
        if (user) {
            const blockCheck = await db.collection("blocked_users").doc(user.uid).get();
            if (blockCheck.exists) { alert("Blocked by Admin!"); auth.signOut(); return; }
            
            loadBranding(); loadPosts(); loadMembers(); listenNoti();
            if (user.email === ADMIN_EMAIL) { showAdmin(); } else { checkStatus(user.uid); }
        } else { window.location.href = "login.html"; }
    });

    function showAdmin() { document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block'); }
    function formatTime(ts) { if(!ts) return ""; return new Date(ts).toLocaleString(); }

    // --- View System ---
    const viewObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                db.collection("page_posts").doc(entry.target.dataset.id).update({ views: firebase.firestore.FieldValue.increment(1) });
                viewObserver.unobserve(entry.target);
            }
        });
    }, { threshold: 0.5 });

    // --- Logic 1: News Feed ---
    function loadPosts() {
        db.collection("page_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
            const feed = document.getElementById('feed');
            const uid = auth.currentUser.uid;

            snap.docChanges().forEach(change => {
                const d = change.doc.data(); const id = change.doc.id;
                const isOwnerOrDev = (d.uid === uid) || (auth.currentUser.email === ADMIN_EMAIL);

                if (change.type === "added") {
                    const div = document.createElement('div'); div.className = "card"; div.id = `post-${id}`; div.dataset.id = id;
                    div.innerHTML = `
                        <div style="font-size:12px; color:gray; margin-bottom:8px;">
                            <b>${d.author}</b> ‚Ä¢ <span id="v-${id}">${d.views || 0}</span> views <br>
                            <span class="time-label">${formatTime(d.createdAt)}</span>
                        </div>
                        <p style="white-space:pre-wrap;">${d.text}</p>
                        ${d.mediaUrl ? (d.mediaType==='video' ? `<video src="${d.mediaUrl}" controls class="post-media"></video>` : `<img src="${d.mediaUrl}" class="post-media">`) : ''}
                        
                        <div class="interaction" id="int-${id}">
                            <span onclick="handleReact('${id}', 'likes')" style="cursor:pointer; color:${(d.likedBy || []).includes(uid) ? 'purple' : 'gray'}">üëç <span id="l-${id}">${d.likes || 0}</span></span>
                            <span onclick="handleReact('${id}', 'hahas')" style="cursor:pointer; color:${(d.hahaedBy || []).includes(uid) ? 'orange' : 'gray'}">üòÜ <span id="h-${id}">${d.hahas || 0}</span></span>
                            <span onclick="toggleC('${id}')" style="cursor:pointer;">üí¨ <span id="cc-${id}">${(d.comments || []).length}</span></span>
                            <span onclick="sharePost('${id}')" style="cursor:pointer; color:purple;">üöÄ Share</span>
                            ${isOwnerOrDev ? `
                                <span onclick="deleteAnythingWithCleanup('${id}')" style="color:red; cursor:pointer;">üóëÔ∏è</span> 
                                <span onclick="togglePin('${id}', ${d.isPinned || false})"
style="color:${d.isPinned ? 'red' : 'gray'}; cursor:pointer;">üìå</span>
                            ` : ''}
                        </div>
                        <div class="comment-box" id="cb-${id}">
                            <div id="cl-${id}"></div>
                            <div style="display:flex; margin-top:10px; gap:5px;">
                                <input type="text" id="cInput-${id}" placeholder="Comment..." style="flex:1; border-radius:15px; border:1px solid #ddd; padding:5px 10px; outline:none;">
                                <button onclick="addComment('${id}')" style="border:none; background:purple; color:white; border-radius:15px; padding:5px 12px;">Send</button>
                            </div>
                        </div>`;
                    feed.appendChild(div);
                    viewObserver.observe(div);
                    loadComments(id);
                }
                if (change.type === "modified") {
    // Counts update ·Äú·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
    const lEl = document.getElementById(`l-${id}`);
    const hEl = document.getElementById(`h-${id}`);
    const vEl = document.getElementById(`v-${id}`);
    
    if (lEl) lEl.innerText = d.likes || 0;
    if (hEl) hEl.innerText = d.hahas || 0;
    if (vEl) vEl.innerText = d.views || 0;

    // ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äª·Ä¨·Ä∏ update ·Äú·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (Specific Selector ·Äû·ÄØ·Ä∂·Ä∏·Äë·Ä¨·Ä∏·Äû·Ää·Ä∫)
    const intBox = document.getElementById(`int-${id}`);
    if (intBox) {
        const likeBtn = intBox.querySelector('span:nth-child(1)');
        const hahaBtn = intBox.querySelector('span:nth-child(2)');
        
        if (likeBtn) likeBtn.style.color = (d.likedBy || []).includes(uid) ? 'purple' : 'gray';
        if (hahaBtn) hahaBtn.style.color = (d.hahaedBy || []).includes(uid) ? 'orange' : 'gray';
    }
}

            });
        });
    }

    // --- Logic 2: Media & Posting ---
    async function handlePost() {
        const text = document.getElementById('postText').value.trim();
        const file = document.getElementById('mediaInput').files[0];
        const btn = document.getElementById('btnPost');
        if(!text && !file) return;
        btn.disabled = true; btn.innerText = "Posting...";

        let mediaUrl = "", mediaType = "";
        if (file) {
            const fName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
            if (file.type.startsWith('video/')) {
                mediaType = 'video';
                const res = await fetch(`https://sg.storage.bunnycdn.com/${BUNNY_STORAGE}/${fName}`, { method: 'PUT', headers: { 'AccessKey': BUNNY_KEY }, body: file });
                if (res.ok) mediaUrl = `https://${BUNNY_STORAGE}.b-cdn.net/${fName}`;
            } else {
                mediaType = 'image';
                const fd = new FormData(); fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
                const d = await res.json(); if (d.success) mediaUrl = d.data.url;
            }
        }
        await db.collection("page_posts").add({ uid: auth.currentUser.uid, author: auth.currentUser.displayName || "Admin", text, mediaUrl, mediaType, likes: 0, likedBy: [], hahas: 0, hahaedBy: [], comments: [], views: 0, isPinned: false, createdAt: Date.now() });
        document.getElementById('postText').value = ""; cancelMedia();
        btn.disabled = false; btn.innerText = "Post";
    }

    function previewMedia(i) {
        const f = i.files[0]; const b = document.getElementById('mediaPreview'); b.style.display = "block";
        b.innerHTML = f.type.startsWith('video') ? `<video src="${URL.createObjectURL(f)}" style="width:100%;" controls></video>` : `<img src="${URL.createObjectURL(f)}" style="width:100%;">`;
        b.innerHTML += `<div onclick="cancelMedia()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:white; border-radius:50%; width:25px; height:25px; text-align:center; cursor:pointer;">√ó</div>`;
    }
    function cancelMedia() { document.getElementById('mediaInput').value = ""; document.getElementById('mediaPreview').style.display = 'none'; }

    // --- Logic 3: Interactions (Reaction/Comment/Share) ---
    async function handleReact(id, type) {
        const ref = db.collection("page_posts").doc(id); const uid = auth.currentUser.uid;
        const snap = await ref.get(); const d = snap.data();
        const field = type === 'likes' ? 'likedBy' : 'hahaedBy';
        const countField = type === 'likes' ? 'likes' : 'hahas';
        if ((d[field] || []).includes(uid)) {
            await ref.update({ [field]: firebase.firestore.FieldValue.arrayRemove(uid), [countField]: firebase.firestore.FieldValue.increment(-1) });
        } else {
            await ref.update({ [field]: firebase.firestore.FieldValue.arrayUnion(uid), [countField]: firebase.firestore.FieldValue.increment(1) });
            sendNoti(`${auth.currentUser.displayName} reacted to your post`);
        }
    }
async function addComment(postId) {
    const val = document.getElementById(`cInput-${postId}`).value.trim();
    if (!val) return;

    await db.collection("page_posts").doc(postId).collection("comments").add({
        uid: auth.currentUser.uid,
        author: auth.currentUser.displayName || "User",
        text: val,
        createdAt: Date.now()
    });

    document.getElementById(`cInput-${postId}`).value = "";
}
function loadComments(postId) {
    db.collection("page_posts").doc(postId).collection("comments")
      .orderBy("createdAt", "asc")
      .onSnapshot(snap => {
        const list = document.getElementById(`cl-${postId}`);
        if (!list) return;
        list.innerHTML = "";
        
        // Comment count ·ÄÄ·Ä≠·ÄØ update ·Äú·ÄØ·Äï·Ä∫·Äï·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        const countBox = document.getElementById(`cc-${postId}`);
        if (countBox) countBox.innerText = snap.size;

        snap.forEach(doc => {
            const c = doc.data();
            const cid = doc.id;
            const uid = auth.currentUser.uid;
            
            list.innerHTML += `
                <div class="c-item">
                    <b>${c.author}</b>: ${c.text}
                    <div style="font-size:11px; margin-top:5px; display:flex; gap:12px;">
                        <span onclick="reactComment('${postId}', '${cid}', 'likes')" 
                              style="cursor:pointer; color:${(c.likedBy || []).includes(uid) ? 'purple' : 'gray'}">
                            üëç ${c.likes || 0}
                        </span>
                        
                        <span onclick="reactComment('${postId}', '${cid}', 'hahas')" 
                              style="cursor:pointer; color:${(c.hahaedBy || []).includes(uid) ? 'orange' : 'gray'}">
                            üòÜ ${c.hahas || 0}
                        </span>
                    </div>
                </div>`;
        });
    });
}
    document.getElementById(`cInput-${postId}`).value = "";
    async function reactComment(postId, commentId, type) {
    const ref = db.collection("page_posts")
        .doc(postId)
        .collection("comments")
        .doc(commentId);

    const snap = await ref.get();
    const d = snap.data();
    const uid = auth.currentUser.uid;

    const field = type === "likes" ? "likedBy" : "hahaedBy";
    const countField = type === "likes" ? "likes" : "hahas";

    if ((d[field] || []).includes(uid)) {
        await ref.update({
            [field]: firebase.firestore.FieldValue.arrayRemove(uid),
            [countField]: firebase.firestore.FieldValue.increment(-1)
        });
    } else {
        await ref.update({
            [field]: firebase.firestore.FieldValue.arrayUnion(uid),
            [countField]: firebase.firestore.FieldValue.increment(1)
        });
    }
}
  async function sharePost(id) {
        const snap = await db.collection("page_posts").doc(id).get();
        await db.collection("health_posts").add({ ...snap.data(), uid: auth.currentUser.uid, isShared: true, createdAt: Date.now() });
        alert("Shared to Profile Successfully!");
    }

    // --- Logic 4: Search & Branding ---
    async function searchPage() {
        const query = document.getElementById('pageSearch').value.toLowerCase();
        const resBox = document.getElementById('searchResults');
        if (!query) { resBox.style.display = "none"; return; }
        const snap = await db.collection("page_info").get();
        resBox.innerHTML = ""; resBox.style.display = "block";
        snap.forEach(doc => {
            if (doc.data().pageTitle?.toLowerCase().includes(query)) {
                resBox.innerHTML += `<div class="search-item" onclick="location.reload()">üìÑ ${doc.data().pageTitle}</div>`;
            }
        });
    }

    function loadBranding() {
        db.collection("page_info").doc("main").onSnapshot(d => {
            if(d.exists){
                document.getElementById('coverDisplay').src = d.data().cover || '';
                document.getElementById('profileDisplay').src = d.data().profile || '';
                document.getElementById('pageNameHeader').innerText = d.data().pageTitle || "Community";
            }
        });
    }

    // --- Logic 5: Admin & Status ---
    async function checkStatus(uid) {
        const uDoc = await db.collection("users").doc(uid).get();
        const isJoined = (await db.collection("page_members").doc(uid).get()).exists;
        const area = document.getElementById('statusArea');
        if (!isJoined) {
            area.innerHTML = `<button class="btn-main" onclick="joinPage()">Join</button> <button class="btn-main" style="background:#444;" onclick="startPageCreation()">Create</button>`;
        } else if (uDoc.data()?.isRequestPending) {
            area.innerHTML = `<small style="color:orange;">Pending Approval for "${uDoc.data()?.requestedPageName}"...</small>`;
        } else if (uDoc.data()?.isPremium) { showAdmin(); }
    }

    async function startPageCreation() {
        const name = prompt("Page Name:");
        if (name && name.length > 2) {
            await db.collection("users").doc(auth.currentUser.uid).set({ isRequestPending: true, requestedPageName: name }, { merge: true });
            await db.collection("admin_requests").add({ uid: auth.currentUser.uid, email: auth.currentUser.email, requestedPageName: name, status: "pending", time: Date.now() });
            alert("Requested Successfully!"); location.reload();
        }
    }

    async function deleteAnythingWithCleanup(id) {
        if(!confirm("Delete?")) return;
        const ref = db.collection("page_posts").doc(id); const d = (await ref.get()).data();
        if (d.mediaUrl?.includes('b-cdn.net')) {
            const f = d.mediaUrl.split('/').pop();
            await fetch(`https://sg.storage.bunnycdn.com/${BUNNY_STORAGE}/${f}`, { method: 'DELETE', headers: { 'AccessKey': BUNNY_KEY } });
        }
        await ref.delete();
    }
// --- Pin function ·Ä°·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ ·Äí·Ä´·Äú·Ä±·Ä∏ ·Ä°·ÄÖ·Ä¨·Ä∏·Äë·Ä≠·ÄØ·Ä∏·Äï·Ä´ ---
async function togglePin(id, curStatus) {
    try {
        await db.collection("page_posts").doc(id).update({ 
            isPinned: !curStatus ? 1 : 0 
        });
    } catch (e) {
        console.error("Pin error:", e);
    }
}

    async function joinPage() { await db.collection("page_members").doc(auth.currentUser.uid).set({ uid: auth.currentUser.uid, joinedAt: Date.now() }); location.reload(); }
    function toggleC(id) { const b = document.getElementById(`cb-${id}`); b.style.display = b.style.display==='block'?'none':'block'; }
    function loadMembers() { db.collection("page_members").onSnapshot(s => document.getElementById('memberCount').innerText = `${s.size} Members`); }
    async function sendNoti(msg) { await db.collection("notifications").add({ receiverId: ADMIN_EMAIL, message: msg, sender: auth.currentUser.displayName || "User", createdAt: Date.now(), status: "unread" }); }
    function listenNoti() {
        if(auth.currentUser.email !== ADMIN_EMAIL) return;
        db.collection("notifications").where("receiverId", "==", ADMIN_EMAIL).where("status", "==", "unread").onSnapshot(s => {
            s.docChanges().forEach(c => { if(c.type==="added") { alert("üîî Noti: " + c.doc.data().message); db.collection("notifications").doc(c.doc.id).update({status:"read"}); }});
        });
    }
    
</script>
</body>
</html>
