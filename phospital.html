<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Page - Senior Final Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        :root { --p: #800080; --bg: #f0f2f5; }
        body { background: var(--bg); margin: 0; font-family: sans-serif; padding-bottom: 70px; }
        .header-box { background: white; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding-bottom: 12px; }
        .cover-area { width: 100%; height: 180px; background: #ddd; position: relative; }
        .cover-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-area { padding: 15px; margin-top: -50px; display: flex; align-items: flex-end; gap: 12px; }
        .p-img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; object-fit: cover; background: #eee; }
        .card { background: white; margin: 12px; padding: 15px; border-radius: 12px; position: relative; }
        .post-media { width: 100%; border-radius: 8px; margin-top: 10px; background: #000; }
        .admin-only { display: none; }
        .interaction { display: flex; justify-content: space-around; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; font-size: 13px; font-weight: bold; }
        .btn-main { background: var(--p); color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; }
        
        /* Search Box Styles */
        .search-container { margin: 10px 15px; position: relative; }
        .search-box { display: flex; background: #f0f2f5; border-radius: 20px; padding: 8px 15px; border: 1px solid #ddd; align-items: center; }
        .search-box input { border: none; outline: none; flex: 1; background: transparent; padding-left: 5px; }
        #searchResults { position: absolute; width: 100%; background: white; z-index: 100; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); top: 45px; display: none; }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

        /* Comment Style */
        .comment-box { margin-top: 10px; border-top: 1px solid #eee; display: none; }
        .c-item { background: #f0f2f5; padding: 10px; border-radius: 12px; margin-top: 8px; font-size: 13px; }
        .c-reacts { font-size: 11px; margin-top: 5px; display: flex; gap: 12px; color: #555; }
        .time-label { font-size: 10px; color: #999; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="header-box">
        <div class="cover-area">
            <img id="coverDisplay" class="cover-img" src="">
            <label class="admin-only" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.5); padding:8px; border-radius:50%; color:white; cursor:pointer;">üì∏<input type="file" hidden onchange="uploadBranding('cover', this)"></label>
        </div>
        <div class="profile-area">
            <div style="position:relative;">
                <img id="profileDisplay" class="p-img" src="">
                <label class="admin-only" style="position:absolute; bottom:5px; right:0; background:rgba(0,0,0,0.5); padding:5px; border-radius:50%; color:white; cursor:pointer;">üì∑<input type="file" hidden onchange="uploadBranding('profile', this)"></label>
            </div>
            <div>
                <h2 id="pageNameHeader" style="font-size: 17px; margin:0;">Emotion Community</h2>
                <p id="memberCount" style="font-size: 11px; color: gray;">0 Members</p>
            </div>
            <div id="statusArea" style="margin-left: auto;"></div>
        </div>

        <div class="search-container">
            <div class="search-box">
                <span>üîç</span>
                <input type="text" id="pageSearch" placeholder="Search page name..." onkeyup="searchPage()">
            </div>
            <div id="searchResults"></div>
        </div>
    </div>

    <div id="postBox" class="card admin-only">
        <textarea id="postText" rows="3" placeholder="·Äò·Ä¨·Äê·ÄΩ·Ä±·Äù·Ä±·Äô·Äª·Äæ·ÄÅ·Äª·ÄÑ·Ä∫·Äú·Ä≤ Senior..." style="width:100%; border:none; outline:none; font-size:15px; resize:none;"></textarea>
        <div id="mediaPreview" style="margin-top:10px; display:none;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
            <label style="cursor:pointer; color:var(--p); font-size:13px; font-weight:bold;">üñºÔ∏è Media <input type="file" id="mediaInput" hidden onchange="previewMedia(this)"></label>
            <button class="btn-main" id="btnPost" onclick="handlePost()">Post</button>
        </div>
    </div>

    <div id="feed"></div>

<script>
    // Firebase Configuration (Senior ·Äõ·Ä≤·Ä∑ ·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏ config)
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const IMGBB_KEY = "C8d8d00185e973ebcafddd34f77a1176";
    const BUNNY_KEY = "a038d7e1-bf94-448b-b863c156422e-7e4a-4299";
    const BUNNY_STORAGE = "public-hospitals";
    const ADMIN_EMAIL = "uwinkyawdevelopbusinessco@gmail.com";

    auth.onAuthStateChanged(async user => {
        if (user) {
            // Block Check
            const blockCheck = await db.collection("blocked_users").doc(user.uid).get();
            if (blockCheck.exists) { alert("Blocked by Admin!"); auth.signOut(); return; }
            
            loadBranding(); loadPosts(); loadMembers(); listenNoti();
            if (user.email === ADMIN_EMAIL) { showAdmin(); } else { checkStatus(user.uid); }
        } else { window.location.href = "login.html"; }
    });

    function showAdmin() { document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block'); }

    // --- Time & Date Formatter ---
    function formatTime(timestamp) {
        if(!timestamp) return "";
        const date = new Date(timestamp);
        return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // --- View Count System ---
    const viewObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.dataset.id;
                db.collection("page_posts").doc(id).update({ views: firebase.firestore.FieldValue.increment(1) });
                viewObserver.unobserve(entry.target);
            }
        });
    }, { threshold: 0.5 });

    // --- Real-time Notification ---
    async function sendNoti(msg) {
        await db.collection("notifications").add({
            receiverId: ADMIN_EMAIL, // Admin ·ÄÜ·ÄÆ Noti ·Äï·Ä≠·ÄØ·Ä∑·Äô·Äö·Ä∫
            message: msg,
            sender: auth.currentUser.displayName || "User",
            createdAt: Date.now(),
            status: "unread"
        });
    }

    function listenNoti() {
        if(auth.currentUser.email !== ADMIN_EMAIL) return;
        db.collection("notifications").where("receiverId", "==", ADMIN_EMAIL).where("status", "==", "unread").onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const n = change.doc.data();
                    alert(`üîî Notification: ${n.message}`);
                    db.collection("notifications").doc(change.doc.id).update({ status: "read" });
                }
            });
        });
    }

    // --- Loading Posts ---
    function loadPosts() {
        db.collection("page_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
            const feed = document.getElementById('feed');
            snap.docChanges().forEach(change => {
                const d = change.doc.data(); const id = change.doc.id;
                if (change.type === "added") {
                    const div = document.createElement('div'); div.className = "card"; div.id = `post-${id}`; div.dataset.id = id;
                    div.innerHTML = `
                        <div style="font-size:12px; color:gray; margin-bottom:8px;">
                            <b>${d.author}</b> ‚Ä¢ <span id="v-${id}">${d.views || 0}</span> views <br>
                            <span class="time-label">${formatTime(d.createdAt)}</span>
                        </div>
                        <p style="white-space:pre-wrap;">${d.text}</p>
                        ${d.mediaUrl ? (d.mediaType==='video' ? `<video src="${d.mediaUrl}" controls class="post-media"></video>` : `<img src="${d.mediaUrl}" class="post-media">`) : ''}
                        <div class="interaction">
                            <span onclick="handleReact('${id}','likes')" style="cursor:pointer;">üëç <span id="l-${id}">${d.likes}</span></span>
                            <span onclick="handleReact('${id}','hahas')" style="cursor:pointer;">üòÜ <span id="h-${id}">${d.hahas}</span></span>
                            <span onclick="toggleC('${id}')" style="cursor:pointer;">üí¨ <span id="cc-${id}">${d.commentsCount || 0}</span></span>
                            <span onclick="sharePost('${id}')" style="cursor:pointer; color:purple;">üöÄ Share</span>
                            ${(auth.currentUser.email === ADMIN_EMAIL) ? `<span onclick="deletePost('${id}')">üóëÔ∏è</span> <span onclick="togglePin('${id}',${d.isPinned})">üìå</span>` : ''}
                        </div>
                        <div class="comment-box" id="cb-${id}">
                            <div id="cl-${id}"></div>
                            <div style="display:flex; margin-top:10px; gap:5px;">
                                <input type="text" id="cInput-${id}" placeholder="Write a comment..." style="flex:1; border-radius:15px; border:1px solid #ddd; padding:5px 10px; outline:none;">
                                <button onclick="addComment('${id}')" style="border:none; background:purple; color:white; border-radius:15px; padding:5px 12px;">Send</button>
                            </div>
                        </div>`;
                    feed.appendChild(div);
                    viewObserver.observe(div);
                    loadComments(id);
                }
                if (change.type === "modified") {
                    document.getElementById(`l-${id}`).innerText = d.likes;
                    document.getElementById(`h-${id}`).innerText = d.hahas;
                    document.getElementById(`cc-${id}`).innerText = d.commentsCount || 0;
                    document.getElementById(`v-${id}`).innerText = d.views || 0;
                }
            });
        });
    }

    // --- Share Logic (Saves to health_posts for profile) ---
    async function sharePost(id) {
        const snap = await db.collection("page_posts").doc(id).get();
        const d = snap.data();
        await db.collection("health_posts").add({
            ...d,
            uid: auth.currentUser.uid,
            isShared: true,
            createdAt: Date.now()
        });
        alert("Shared to Profile Successfully!");
        sendNoti(`${auth.currentUser.displayName} ·ÄÄ Post ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·ÄÄ·Ä≠·ÄØ Share ·Äú·ÄØ·Äï·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫`);
    }

   async function checkStatus(uid) {
    const uDoc = await db.collection("users").doc(uid).get();
    const isJoined = (await db.collection("page_members").doc(uid).get()).exists;
    const area = document.getElementById('statusArea');

    if (!isJoined) {
        area.innerHTML = `
            <button class="btn-main" onclick="joinPage()">Join</button> 
            <button class="btn-main" style="background:#444;" onclick="startPageCreation()">Create</button>
        `;
    } else if (uDoc.data()?.isRequestPending) {
        area.innerHTML = `<small style="color:orange;">Pending Approval for "${uDoc.data()?.requestedPageName}"...</small>`;
    } else if (uDoc.data()?.isPremium) {
        showAdmin();
    }
}

async function startPageCreation() {
    const pageName = prompt("·Äû·ÄÑ·Ä∫·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·ÄÅ·Äª·ÄÑ·Ä∫·Äû·Ä±·Ä¨ Page ·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ Senior:");
    
    if (pageName && pageName.trim().length > 2) {
        const uid = auth.currentUser.uid;
        const email = auth.currentUser.email;

        // User data ·Äô·Äæ·Ä¨ ·Äî·Ä¨·Äô·Ää·Ä∫·Äî·Ä≤·Ä∑ Pending status ·ÄÄ·Ä≠·ÄØ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Äö·Ä∫
        await db.collection("users").doc(uid).set({ 
            isRequestPending: true,
            requestedPageName: pageName 
        }, { merge: true });

        // Developer ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äñ·Ä≠·ÄØ·Ä∑ admin_requests ·Äë·Ä≤·ÄÄ·Ä≠·ÄØ ·Äï·Ä≠·ÄØ·Ä∑·Äô·Äö·Ä∫
        await db.collection("admin_requests").add({
            uid: uid,
            email: email,
            requestedPageName: pageName,
            status: "pending",
            time: Date.now()
        });

        alert(`"${pageName}" Page ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã Developer ·Äô·Äæ Approve ·Äú·ÄØ·Äï·Ä∫·Äï·Ä±·Ä∏·Äû·Ää·Ä∫·Ä°·Äë·Ä≠ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´·Äó·Äª·Åã`);
        location.reload();
    } else {
        alert("Page ·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ ·Ä°·Äî·Ää·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÅÉ ·Äú·ÄØ·Ä∂·Ä∏ ·Äõ·Äæ·Ä≠·Äõ·Äï·Ä´·Äô·Äö·Ä∫·Äó·Äª·Åã");
    }
}

    async function reqCreate() {
        await db.collection("users").doc(auth.currentUser.uid).set({ isRequestPending: true }, { merge: true });
        // Admin Request Collection ·Äë·Ä≤·ÄÄ·Ä≠·ÄØ Data ·Äï·Ä≠·ÄØ·Ä∑·Äô·Äö·Ä∫ (Index: time desc)
        await db.collection("admin_requests").add({
            uid: auth.currentUser.uid,
            email: auth.currentUser.email,
            status: "pending",
            time: Date.now()
        });
        alert("Developer ·Äë·Ä∂ ·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫ ·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ!");
        location.reload();
    }

    // --- ·Äô·Ä∞·Äú·Äï·Ä´·Äù·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏ Functions ·Äô·Äª·Ä¨·Ä∏ ---
    async function handlePost() {
        const text = document.getElementById('postText').value;
        const file = document.getElementById('mediaInput').files[0];
        const btn = document.getElementById('btnPost'); btn.disabled = true;
        let mediaUrl = "", mediaType = "";
        if (file) {
            const fd = new FormData(); fd.append('image', file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
            const d = await res.json(); if (d.success) mediaUrl = d.data.url, mediaType = "image";
        }
        await db.collection("page_posts").add({
            text, mediaUrl, mediaType, createdAt: Date.now(),
            likes:0, hahas:0, views:0, commentsCount:0, isPinned:false, author:"Admin"
        });
        location.reload();
    }

    async function handleReact(id, type) {
        const rRef = db.collection("page_posts").doc(id).collection("reactions").doc(auth.currentUser.uid);
        if ((await rRef.get()).exists) return;
        await rRef.set({ type, time: Date.now() });
        await db.collection("page_posts").doc(id).update({ [type]: firebase.firestore.FieldValue.increment(1) });
        sendNoti(`${auth.currentUser.displayName} ·ÄÄ Post ·ÄÄ·Ä≠·ÄØ ${type} ·Äï·Ä±·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫`);
    }

    async function addComment(id) {
        const val = document.getElementById(`cInput-${id}`).value;
        if(!val) return;
        await db.collection("page_posts").doc(id).collection("comments").add({
            author: auth.currentUser.displayName || "User",
            text: val, createdAt: Date.now(), likes: 0, hahas: 0
        });
        await db.collection("page_posts").doc(id).update({ commentsCount: firebase.firestore.FieldValue.increment(1) });
        sendNoti(`${auth.currentUser.displayName} ·ÄÄ Comment ·Äõ·Ä±·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫`);
        document.getElementById(`cInput-${id}`).value = "";
    }

    function loadComments(postId) {
        db.collection("page_posts").doc(postId).collection("comments").orderBy("createdAt", "asc").onSnapshot(snap => {
            const list = document.getElementById(`cl-${postId}`); list.innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                list.innerHTML += `
                    <div class="c-item">
                        <b>${c.author}</b>: ${c.text} <br>
                        <small style="color:#999; font-size:9px;">${formatTime(c.createdAt)}</small>
                    </div>`;
            });
        });
    }

    async function searchPage() {
        const query = document.getElementById('pageSearch').value.toLowerCase();
        const resBox = document.getElementById('searchResults');
        if (!query) { resBox.style.display = "none"; return; }
        const snap = await db.collection("page_info").get();
        resBox.innerHTML = "";
        snap.forEach(doc => {
            if (doc.data().pageTitle.toLowerCase().includes(query)) {
                resBox.style.display = "block";
                resBox.innerHTML += `<div class="search-item" onclick="location.reload()">üìÑ ${doc.data().pageTitle}</div>`;
            }
        });
    }

    async function joinPage() { await db.collection("page_members").doc(auth.currentUser.uid).set({ uid: auth.currentUser.uid, joinedAt: Date.now() }); location.reload(); }
    function toggleC(id) { const b = document.getElementById(`cb-${id}`); b.style.display = b.style.display==='block'?'none':'block'; }
    async function deletePost(id) { if(confirm("Delete Post?")) await db.collection("page_posts").doc(id).delete(); }
    async function togglePin(id, cur) { await db.collection("page_posts").doc(id).update({ isPinned: !cur }); }
    function loadBranding() { db.collection("page_info").doc("main").onSnapshot(d => { if(d.exists){ document.getElementById('coverDisplay').src = d.data().cover; document.getElementById('profileDisplay').src = d.data().profile; }}); }
    function loadMembers() { db.collection("page_members").onSnapshot(s => document.getElementById('memberCount').innerText = `${s.size} Members`); }
    function previewMedia(i) { const f = i.files[0]; const b = document.getElementById('mediaPreview'); b.style.display="block"; b.innerHTML = `<img src="${URL.createObjectURL(f)}" style="width:100%; border-radius:8px;">`; }
    function loadBranding() {
    db.collection("page_info").doc("main").onSnapshot(d => {
        if(d.exists){
            document.getElementById('coverDisplay').src = d.data().cover || '';
            document.getElementById('profileDisplay').src = d.data().profile || '';
            // ·Ä°·ÄÄ·Äö·Ä∫·Åç DB ·Äô·Äæ·Ä¨ ·Äî·Ä¨·Äô·Ää·Ä∫·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ ·Ä°·Ä≤·Ä∑·Äí·ÄÆ·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äô·Äö·Ä∫·Åä ·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ Default ·Äî·Ä¨·Äô·Ää·Ä∫·Äï·Äº·Äô·Äö·Ä∫
            document.getElementById('pageNameHeader').innerText = d.data().pageTitle || "Emotion Community";
        }
    });
}

</script>
</body>
</html>
