<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Page - Senior Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        :root { --p: #800080; --bg: #f0f2f5; }
        body { background: var(--bg); margin: 0; font-family: sans-serif; padding-bottom: 70px; }
        .header-box { background: white; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .cover-area { width: 100%; height: 180px; background: #ddd; position: relative; }
        .cover-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-area { padding: 15px; margin-top: -50px; display: flex; align-items: flex-end; gap: 12px; }
        .p-img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; object-fit: cover; background: #eee; }
        .card { background: white; margin: 12px; padding: 15px; border-radius: 12px; position: relative; }
        .post-media { width: 100%; border-radius: 8px; margin-top: 10px; background: #000; }
        .admin-only { display: none; }
        .interaction { display: flex; justify-content: space-around; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
        .btn-main { background: var(--p); color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header-box">
        <div class="cover-area">
            <img id="coverDisplay" class="cover-img" src="">
            <label class="admin-only" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.5); padding:8px; border-radius:50%; color:white; cursor:pointer;">üì∏<input type="file" hidden onchange="uploadBranding('cover', this)"></label>
        </div>
        <div class="profile-area">
            <div style="position:relative;">
                <img id="profileDisplay" class="p-img" src="">
                <label class="admin-only" style="position:absolute; bottom:5px; right:0; background:rgba(0,0,0,0.5); padding:5px; border-radius:50%; color:white; cursor:pointer;">üì∑<input type="file" hidden onchange="uploadBranding('profile', this)"></label>
            </div>
            <div>
                <h2 id="pageTitle" style="font-size: 18px;">Emotion Community</h2>
                <p id="memberCount" style="font-size: 11px; color: gray;">0 Members</p>
            </div>
            <div id="statusArea" style="margin-left: auto;"></div>
        </div>
    </div>

    <div id="postBox" class="card admin-only">
        <textarea id="postText" rows="3" placeholder="·Äò·Ä¨·Äê·ÄΩ·Ä±·Äù·Ä±·Äô·Äª·Äæ·ÄÅ·Äª·ÄÑ·Ä∫·Äú·Ä≤ Senior..." style="width:100%; border:none; outline:none; font-size:15px;"></textarea>
        <div id="mediaPreview" style="margin-top:10px; display:none;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
            <label style="cursor:pointer; color:var(--p); font-size:13px; font-weight:bold;">üñºÔ∏è Media (Max 30MB) <input type="file" id="mediaInput" hidden onchange="previewMedia(this)"></label>
            <button class="btn-main" id="btnPost" onclick="handlePost()">Post</button>
        </div>
    </div>

    <div id="feed"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const IMGBB_KEY = "C8d8d00185e973ebcafddd34f77a1176";
    const BUNNY_KEY = "a038d7e1-bf94-448b-b863c156422e-7e4a-4299";
    const BUNNY_STORAGE = "public-hospitals";
    const ADMIN_EMAIL = "uwinkyawdevelopbusinessco@gmail.com";

    auth.onAuthStateChanged(user => {
        if (user) {
            loadBranding(); loadPosts(); loadMembers();
            if (user.email === ADMIN_EMAIL) { showAdmin(); } else { checkStatus(user.uid); }
        } else { window.location.href = "login.html"; }
    });

    function showAdmin() { document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block'); }

    // ·ÅÅ·ÅÄ·ÅÄ% Real-time Reaction (Refresh ·Äô·Äñ·Äº·ÄÖ·Ä∫·ÄÖ·Ä±·Äõ·Äî·Ä∫ DocChanges ·Äû·ÄØ·Ä∂·Ä∏·Äë·Ä¨·Ä∏·Äû·Ää·Ä∫)
    async function handleReact(postId, type) {
        const uid = auth.currentUser.uid;
        const postRef = db.collection("page_posts").doc(postId);
        const reactRef = postRef.collection("reactions").doc(uid);

        const reactDoc = await reactRef.get();
        if (reactDoc.exists) return alert("·Äê·ÄÖ·Ä∫·ÄÄ·Äº·Ä≠·Äô·Ä∫·Äû·Ä¨ ·Äï·Ä±·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫!");

        await reactRef.set({ type, time: Date.now() });
        await postRef.update({ [type]: firebase.firestore.FieldValue.increment(1) });
    }

    // Video 20% ·Äï·Äª·Ä±·Ä¨·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫ ·Ä°·Ä±·Ä¨·Ä∫·Äê·Ä≠·ÄØ·Äï·Ä≠·Äê·Ä∫·ÄÖ·Äî·ÄÖ·Ä∫
    const videoObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => { if (entry.intersectionRatio < 0.8) entry.target.pause(); });
    }, { threshold: 0.8 });

    // Scroll ·ÄÜ·ÄΩ·Ä≤·Äõ·ÄÑ·Ä∫ Views ·Äê·Ä≠·ÄØ·Ä∏·ÄÖ·Äî·ÄÖ·Ä∫
    const viewObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                db.collection("page_posts").doc(entry.target.dataset.id).update({ views: firebase.firestore.FieldValue.increment(1) });
                viewObserver.unobserve(entry.target);
            }
        });
    }, { threshold: 0.5 });

    async function handlePost() {
        const text = document.getElementById('postText').value;
        const file = document.getElementById('mediaInput').files[0];
        const btn = document.getElementById('btnPost');

        if (file && file.size > 30 * 1024 * 1024) return alert("30MB ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ä¨ ·Äê·ÄÑ·Ä∫·Äï·Ä´!");
        btn.disabled = true; btn.innerText = "·Äê·ÄÑ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫...";

        let mediaUrl = "", mediaType = "";
        if (file) {
            if (file.type.startsWith('video/')) {
                const name = `${Date.now()}_${file.name}`;
                const res = await fetch(`https://sg.storage.bunnycdn.com/${BUNNY_STORAGE}/${name}`, {
                    method: 'PUT', headers: { 'AccessKey': BUNNY_KEY }, body: file
                });
                if (res.ok) { mediaUrl = `https://public-hospitals.b-cdn.net/${name}`; mediaType = "video"; }
            } else {
                const fd = new FormData(); fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
                const d = await res.json();
                if (d.success) { mediaUrl = d.data.url; mediaType = "image"; }
            }
        }

        await db.collection("page_posts").add({
            text, mediaUrl, mediaType, createdAt: Date.now(),
            likes: 0, hahas: 0, views: 0, isPinned: false, author: "Admin"
        });
        location.reload();
    }

    function loadPosts() {
        db.collection("page_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
            const feed = document.getElementById('feed');
            snap.docChanges().forEach(change => {
                const d = change.doc.data(); const id = change.doc.id;
                if (change.type === "added") {
                    const div = document.createElement('div'); div.className = "card"; div.id = `post-${id}`; div.dataset.id = id;
                    div.innerHTML = `
                        ${d.isPinned ? '<span style="position:absolute; top:10px; right:10px; color:purple; font-weight:bold;">üìå Pinned</span>' : ''}
                        <div style="font-size:12px; color:gray; margin-bottom:8px;"><b>${d.author}</b> ‚Ä¢ ${d.views || 0} views</div>
                        <p style="white-space:pre-wrap;">${d.text}</p>
                        ${d.mediaUrl ? (d.mediaType === 'video' ? `<video src="${d.mediaUrl}" controls class="post-media"></video>` : `<img src="${d.mediaUrl}" class="post-media">`) : ''}
                        <div class="interaction">
                            <span onclick="handleReact('${id}', 'likes')" style="cursor:pointer;">üëç <span id="l-${id}">${d.likes || 0}</span></span>
                            <span onclick="handleReact('${id}', 'hahas')" style="cursor:pointer;">üòÜ <span id="h-${id}">${d.hahas || 0}</span></span>
                            <span onclick="sharePost('${id}')" style="cursor:pointer; color:purple; font-weight:bold;">üöÄ Share</span>
                            ${(auth.currentUser.email === ADMIN_EMAIL) ? `<span onclick="deletePost('${id}')" style="cursor:pointer;">üóëÔ∏è</span> <span onclick="togglePin('${id}',${d.isPinned})" style="cursor:pointer;">üìå</span>` : ''}
                        </div>`;
                    feed.appendChild(div);
                    if (d.mediaType === 'video') videoObserver.observe(div.querySelector('video'));
                    viewObserver.observe(div);
                }
                if (change.type === "modified") {
                    document.getElementById(`l-${id}`).innerText = d.likes;
                    document.getElementById(`h-${id}`).innerText = d.hahas;
                }
                if (change.type === "removed") document.getElementById(`post-${id}`).remove();
            });
        });
    }

    async function sharePost(id) {
        const snap = await db.collection("page_posts").doc(id).get(); const d = snap.data();
        await db.collection("health_posts").add({
            text: d.text, mediaUrl: d.mediaUrl, mediaType: d.mediaType, uid: auth.currentUser.uid,
            author: auth.currentUser.displayName, createdAt: Date.now(), isShared: true
        });
        alert("Shared to Profile!");
    }

    async function deletePost(id) { if(confirm("·Äñ·Äª·ÄÄ·Ä∫·Äô·Äæ·Ä¨·Äú·Ä¨·Ä∏ Senior?")) await db.collection("page_posts").doc(id).delete(); }
    async function togglePin(id, cur) { await db.collection("page_posts").doc(id).update({ isPinned: !cur }); location.reload(); }
    
    async function uploadBranding(type, input) {
        const file = input.files[0]; if(!file) return;
        const fd = new FormData(); fd.append('image', file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
        const d = await res.json();
        if(d.success) await db.collection("page_info").doc("main").set({ [type]: d.data.url }, { merge: true });
    }

    function previewMedia(input) {
        const file = input.files[0]; if(!file) return;
        const box = document.getElementById('mediaPreview'); box.style.display = "block";
        box.innerHTML = file.type.startsWith('video') ? `<video src="${URL.createObjectURL(file)}" style="width:100%" muted autoplay loop></video>` : `<img src="${URL.createObjectURL(file)}" style="width:100%; border-radius:8px;">`;
    }

    function loadBranding() { db.collection("page_info").doc("main").onSnapshot(d => { if(d.exists){ document.getElementById('coverDisplay').src = d.data().cover || ''; document.getElementById('profileDisplay').src = d.data().profile || ''; }}); }
    function loadMembers() { db.collection("page_members").onSnapshot(s => document.getElementById('memberCount').innerText = `${s.size} Members`); }
    async function checkStatus(uid) { 
        const isJoined = (await db.collection("page_members").doc(uid).get()).exists;
        const area = document.getElementById('statusArea');
        if (!isJoined) area.innerHTML = `<button class="btn-main" onclick="joinPage()">Join</button>`;
    }
    async function joinPage() { await db.collection("page_members").doc(auth.currentUser.uid).set({ uid: auth.currentUser.uid, joinedAt: Date.now() }); location.reload(); }
</script>
</body>
</html>
