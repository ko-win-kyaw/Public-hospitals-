<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Community - Full Features</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root { --primary: #800080; --bg: #f0f2f5; --danger: #ff4d4d; --pinned: #fff9c4; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        
        /* Header Fix: Home á€á€œá€¯á€á€º á€•á€«á€á€„á€ºá€á€Šá€º */
        .header { background: var(--primary); color: white; padding: 12px 15px; text-align: center; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; flex-direction: column; align-items: flex-start; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .btn-home { background: white; border: none; padding: 6px 10px; border-radius: 6px; text-decoration: none; font-size: 18px; cursor: pointer; }
        .admin-login-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; }

        .container { max-width: 500px; margin: auto; padding: 10px; }
        .post-card, .feed-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .feed-card.pinned { border: 2px solid #ffd700; background: var(--pinned); }
        
        /* Rating Stats Box */
        .rating-stat-box { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: center; border: 1px solid #ddd; }
        .stat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .stat-item { font-size: 11px; background: #f8f9fa; padding: 5px; border-radius: 5px; }

        textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 12px; box-sizing: border-box; resize: none; font-size: 15px; outline: none; background: #f5f6f7; }
        .btn-post { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        
        /* Admin Buttons */
        .del-btn, .pin-btn { font-size: 11px; cursor: pointer; font-weight: bold; display: none; }
        .del-btn { color: var(--danger); margin-left: 10px; }
        .pin-btn { color: #555; }

        .action-bar { display: flex; border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; justify-content: space-around; }
        .action-btn { background: none; border: none; color: #65676b; cursor: pointer; font-size: 13px; font-weight: 600; }
        
        .comment-section { margin-top: 10px; background: rgba(0,0,0,0.03); border-radius: 8px; padding: 10px; }
        .comment-item { background: white; border-radius: 10px; padding: 8px; margin-bottom: 5px; font-size: 13px; border: 1px solid #eee; }
        .comment-react { font-size: 11px; color: #65676b; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div style="font-weight: bold;">Health Community</div>
        <small id="userNameDisplay" style="font-size: 10px; opacity: 0.9;">Loading...</small>
    </div>
    <div class="header-right">
        <button id="adminLoginBtn" class="admin-login-btn" onclick="adminLogin()">ğŸ”‘ Admin</button>
        <a href="index.html" class="btn-home">ğŸ </a>
    </div>
</div>

<div class="container">
    <div class="rating-stat-box">
        <h4 style="margin: 0 0 5px 0; color: var(--primary);">Overall App Rating</h4>
        <div id="averageRatingDisplay" style="font-size: 22px; font-weight: bold;">â­ Loading...</div>
        <div class="stat-grid">
            <div class="stat-item">5â­:<br><b id="c5">0</b></div>
            <div class="stat-item">4â­:<br><b id="c4">0</b></div>
            <div class="stat-item">3â­:<br><b id="c3">0</b></div>
            <div class="stat-item">2â­:<br><b id="c2">0</b></div>
            <div class="stat-item">1â­:<br><b id="c1">0</b></div>
        </div>
    </div>

    <div class="post-card">
        <h3 style="color: var(--primary); margin: 0 0 10px 0; font-size: 16px;">Rate this App</h3>
        <div id="ratingStars" style="font-size: 30px; color: #ddd; cursor: pointer; margin-bottom: 10px; display: flex; gap: 5px; justify-content: center;">
            <span onclick="setRating(1)">â­</span><span onclick="setRating(2)">â­</span><span onclick="setRating(3)">â­</span><span onclick="setRating(4)">â­</span><span onclick="setRating(5)">â­</span>
        </div>
        <textarea id="feedbackText" rows="2" placeholder="á€¡á€€á€¼á€¶á€•á€¼á€¯á€á€»á€€á€ºá€›á€±á€¸á€›á€”á€º..."></textarea>
        <button class="btn-post" onclick="submitFeedback()">Feedback á€•á€±á€¸á€™á€Šá€º</button>
    </div>

    <div class="post-card">
        <textarea id="postContent" rows="3" placeholder="á€˜á€¬á€á€½á€± á€™á€»á€¾á€á€±á€á€»á€„á€ºá€•á€«á€á€œá€²..."></textarea>
        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="previewImage(this)">
        <label for="imageInput" style="display:inline-block; margin-top:10px; padding:8px; background:#eee; border-radius:6px; cursor:pointer; font-size:12px;">ğŸ“· á€•á€¯á€¶á€‘á€Šá€·á€ºá€™á€Šá€º</label>
        <img id="imgPreview" style="width:100%; border-radius:8px; margin-top:10px; display:none;">
        <button id="btnPost" class="btn-post" onclick="uploadAndPost()">Post á€á€„á€ºá€™á€Šá€º</button>
    </div>

    <div id="newsFeed"></div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2",
        measurementId: "G-G2ZW22W3BM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const IMGBB_API_KEY = "C8d8d00185e973ebcafddd34f77a1176";
    const ADMIN_EMAIL = "uwinkyawdevelopbusinessco@gmail.com";

    let userName = localStorage.getItem("health_user_name");
    let selectedRating = 0;

    auth.signInAnonymously().catch(e => console.error(e));

    auth.onAuthStateChanged((user) => {
        if (user) {
            if (user.email === ADMIN_EMAIL) {
                userName = "Admin Developer";
            } else if (!userName) {
                userName = prompt("á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€á€„á€·á€ºá€”á€¬á€™á€Šá€ºá€€á€­á€¯ á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«:") || "Guest";
                localStorage.setItem("health_user_name", userName);
            }
            document.getElementById('userNameDisplay').innerText = "á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°: " + userName;
            refreshFeed();
        }
    });

    // Rating Logic
    function setRating(n) {
        selectedRating = n;
        document.querySelectorAll('#ratingStars span').forEach((s, i) => s.style.color = i < n ? "#ffc107" : "#ddd");
    }

    async function submitFeedback() {
        const text = document.getElementById('feedbackText').value.trim();
        if (selectedRating === 0 || !text) return alert("á€€á€¼á€šá€ºá€•á€½á€„á€·á€ºá€”á€¾á€„á€·á€º á€…á€¬á€á€¬á€¸ á€–á€¼á€Šá€·á€ºá€•á€«");
        try {
            await db.collection("app_feedback").add({ rating: selectedRating, createdAt: Date.now() });
            await db.collection("health_posts").add({
                author: userName, text: `â­ Rated the App: ${selectedRating}/5\n"${text}"`,
                imageUrl: "", likes: 0, hahas: 0, comments: [], isPinned: false, createdAt: Date.now()
            });
            document.getElementById('feedbackText').value = ""; setRating(0);
            alert("á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€º!");
        } catch(e) { alert(e.message); }
    }

    // Post & Image Logic
    function previewImage(input) {
        const preview = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function uploadAndPost() {
        const text = document.getElementById('postContent').value.trim();
        const file = document.getElementById('imageInput').files[0];
        const btn = document.getElementById('btnPost');
        if (!text && !file) return;

        btn.disabled = true; btn.innerText = "á€á€„á€ºá€”á€±á€á€Šá€º...";
        let imageUrl = "";
        try {
            if (file) {
                const formData = new FormData(); formData.append("image", file);
                const resp = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const data = await resp.json(); imageUrl = data.data.url;
            }
            await db.collection("health_posts").add({
                author: userName, text: text, imageUrl: imageUrl,
                likes: 0, hahas: 0, comments: [], isPinned: false, createdAt: Date.now()
            });
            document.getElementById('postContent').value = "";
            document.getElementById('imgPreview').style.display = 'none';
        } catch (e) { alert(e.message); } finally { btn.disabled = false; btn.innerText = "Post á€á€„á€ºá€™á€Šá€º"; }
    }

    // Feed Rendering (Comment Reaction & Admin Buttons á€•á€«á€á€„á€ºá€á€Šá€º)
    function refreshFeed() {
        db.collection("health_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
            const feed = document.getElementById('newsFeed'); feed.innerHTML = "";
            const isAdmin = auth.currentUser && auth.currentUser.email === ADMIN_EMAIL;

            snap.forEach(doc => {
                const d = doc.data(); const id = doc.id;
                const adminVisibility = isAdmin ? "display:inline-block;" : "display:none;";

                const cList = (d.comments || []).map(c => `
                    <div class="comment-item">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${c.author}</b>
                            <span class="del-btn" style="${adminVisibility}" onclick="deleteItem('${id}', '${c.id}')">ğŸ—‘ï¸</span>
                        </div>
                        <p style="margin:5px 0;">${c.text}</p>
                        <div class="comment-react">
                            <span onclick="react('${id}', 'likes', '${c.id}')">ğŸ‘ ${c.likes || 0}</span>
                            <span onclick="react('${id}', 'hahas', '${c.id}')" style="margin-left:12px;">ğŸ˜† ${c.hahas || 0}</span>
                        </div>
                    </div>`).join('');

                feed.innerHTML += `
                    <div class="feed-card ${d.isPinned ? 'pinned' : ''}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong style="color:var(--primary); font-size:13px;">${d.isPinned ? 'ğŸ“Œ PINNED' : d.author}</strong>
                            <div style="${adminVisibility}">
                                <span class="pin-btn" style="display:inline;" onclick="togglePin('${id}', ${d.isPinned})">ğŸ“ Pin</span>
                                <span class="del-btn" style="display:inline;" onclick="deleteItem('${id}')">ğŸ—‘ï¸</span>
                            </div>
                        </div>
                        <p style="white-space:pre-wrap; margin:10px 0; font-size:15px;">${d.text}</p>
                        ${d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%; border-radius:8px; margin-bottom:10px;">` : ''}
                        <div class="action-bar">
                            <button class="action-btn" onclick="react('${id}', 'likes')">ğŸ‘ Like (${d.likes || 0})</button>
                            <button class="action-btn" onclick="react('${id}', 'hahas')">ğŸ˜† Haha (${d.hahas || 0})</button>
                        </div>
                        <div class="comment-section">${cList}
                            <div style="display:flex; gap:5px; margin-top:10px;">
                                <input type="text" id="in-${id}" class="comment-input" style="flex:1; border-radius:15px; border:1px solid #ddd; padding:5px 10px; outline:none;" placeholder="á€™á€¾á€á€ºá€á€»á€€á€º...">
                                <button onclick="addComment('${id}')" style="border:none; background:none; color:purple; font-weight:bold;">Send</button>
                            </div>
                        </div>
                    </div>`;
            });
        });
    }

    // Reaction & Admin Functions
    async function react(id, type, cId = null) {
        const docRef = db.collection("health_posts").doc(id);
        const doc = await docRef.get();
        if (cId) {
            const updated = doc.data().comments.map(c => { 
                if(c.id === cId) c[type] = (c[type] || 0) + 1; return c; 
            });
            await docRef.update({ comments: updated });
        } else { await docRef.update({ [type]: firebase.firestore.FieldValue.increment(1) }); }
    }

    async function addComment(id) {
        const input = document.getElementById(`in-${id}`);
        if(!input.value.trim()) return;
        await db.collection("health_posts").doc(id).update({ 
            comments: firebase.firestore.FieldValue.arrayUnion({ id: Date.now().toString(), author: userName, text: input.value, likes: 0, hahas: 0 }) 
        });
        input.value = "";
    }

    async function deleteItem(pId, cId = null) {
        if (!confirm("á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) return;
        const docRef = db.collection("health_posts").doc(pId);
        if (cId) {
            const doc = await docRef.get();
            const filtered = doc.data().comments.filter(c => c.id !== cId);
            await docRef.update({ comments: filtered });
        } else { await docRef.delete(); }
    }

    async function togglePin(id, status) {
        await db.collection("health_posts").doc(id).update({ isPinned: !status });
    }

    async function adminLogin() {
        try {
            const res = await auth.signInWithPopup(provider);
            if(res.user.email === ADMIN_EMAIL) { alert("Admin Login Success!"); refreshFeed(); }
            else { alert("Admin á€¡á€€á€±á€¬á€„á€·á€ºá€™á€Ÿá€¯á€á€ºá€•á€«"); await auth.signOut(); }
        } catch (e) { alert(e.message); }
    }

    // Statistic Listener
    db.collection("app_feedback").onSnapshot(snap => {
        let total = 0; let counts = {1:0, 2:0, 3:0, 4:0, 5:0};
        snap.forEach(doc => { const r = doc.data().rating; total += r; counts[r]++; });
        const avg = snap.size === 0 ? "0.0" : (total / snap.size).toFixed(1);
        document.getElementById('averageRatingDisplay').innerText = `â­ ${avg} / 5.0`;
        for(let i=1; i<=5; i++) document.getElementById(`c${i}`).innerText = counts[i];
    });
</script>
</body>
</html>
