<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Community - User</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root { --primary: #800080; --bg: #f0f2f5; --danger: #ff4d4d; --pinned: #fff9c4; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .back-btn button { background: white; border: none; border-radius: 5px; cursor: pointer; padding: 5px 10px; }
        .admin-login-btn { background: #fff; color: var(--primary); border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .container { max-width: 500px; margin: auto; padding: 10px; }
        .post-card, .feed-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .feed-card.pinned { border: 2px solid #ffd700; background: var(--pinned); }
        textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 12px; box-sizing: border-box; resize: none; font-size: 16px; outline: none; background: #f5f6f7; }
        .btn-post { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        .btn-post:disabled { background: #ccc; }
        .del-btn { color: var(--danger); font-size: 11px; cursor: pointer; font-weight: bold; }
        .pin-btn { color: #555; font-size: 11px; cursor: pointer; font-weight: bold; margin-right: 10px; }
        .action-bar { display: flex; border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; justify-content: space-around; }
        .action-btn { background: none; border: none; color: #65676b; cursor: pointer; font-size: 14px; font-weight: 600; }
        .comment-section { margin-top: 10px; background: rgba(0,0,0,0.03); border-radius: 8px; padding: 10px; }
        .comment-item { background: white; border-radius: 10px; padding: 8px; margin-bottom: 5px; font-size: 13px; border: 1px solid #eee; }
        .comment-input-box { display: flex; gap: 5px; margin-top: 10px; }
        .comment-input { flex: 1; border-radius: 20px; border: 1px solid #ddd; padding: 6px 12px; outline: none; }
        
        .rating-stat-box { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: center; border: 1px solid #ddd; }
        .stat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .stat-item { font-size: 12px; background: #f8f9fa; padding: 5px; border-radius: 5px; border: 1px solid #eee; }
        
        /* Media Input Style */
        .image-upload-label { display: inline-block; margin-top: 10px; padding: 8px 12px; background: #eee; border-radius: 6px; cursor: pointer; font-size: 13px; color: #555; }
        .image-preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="header">
    <div style="text-align: left;">
        <div>Health Community Feed</div>
        <small id="userNameDisplay" style="font-size: 10px; opacity: 0.8;"></small>
    </div>
    <div>
        <button id="adminLoginBtn" class="admin-login-btn" onclick="adminLogin()"> üîë</button>
        <a href="index.html" class="back-btn"><button>üè†</button></a>
    </div>
</div>

<div class="container">
    <div class="rating-stat-box">
        <h4 style="margin: 0 0 10px 0; color: var(--primary);">Overall App Rating</h4>
        <div id="averageRatingDisplay" style="font-size: 24px; font-weight: bold; color: #333;">‚≠ê Loading...</div>
        <div class="stat-grid" id="ratingCounts">
            <div class="stat-item">5‚≠ê: <span id="c5">0</span></div>
            <div class="stat-item">4‚≠ê: <span id="c4">0</span></div>
            <div class="stat-item">3‚≠ê: <span id="c3">0</span></div>
            <div class="stat-item">2‚≠ê: <span id="c2">0</span></div>
            <div class="stat-item">1‚≠ê: <span id="c1">0</span></div>
        </div>
    </div>

    <div class="post-card">
        <h3 style="color: var(--primary); margin: 0 0 10px 0;">Rate this App</h3>
        <div id="ratingStars" style="font-size: 35px; color: #ddd; cursor: pointer; margin-bottom: 10px; display: flex; gap: 5px; justify-content: center;">
            <span onclick="setRating(1)">‚≠ê</span><span onclick="setRating(2)">‚≠ê</span><span onclick="setRating(3)">‚≠ê</span><span onclick="setRating(4)">‚≠ê</span><span onclick="setRating(5)">‚≠ê</span>
        </div>
        <textarea id="feedbackText" rows="2" placeholder="·Äí·ÄÆ App ·Ä°·Äï·Ä±·Ä´·Ä∫ ·Äû·ÄÑ·Ä∑·Ä∫·Ä°·Äô·Äº·ÄÑ·Ä∫·ÄÄ·Ä≠·ÄØ ·Äõ·Ä±·Ä∏·Äï·Ä±·Ä∏·Äï·Ä´..."></textarea>
        <button class="btn-post" onclick="submitFeedback()">Feedback ·Äï·Ä±·Ä∏·Äô·Ää·Ä∫</button>
    </div>

    <div class="post-card">
        <textarea id="postContent" rows="3" placeholder="·Äò·Ä¨·Äê·ÄΩ·Ä± ·Äô·Äª·Äæ·Äù·Ä±·ÄÅ·Äª·ÄÑ·Ä∫·Äï·Ä´·Äû·Äú·Ä≤..."></textarea>
        <label class="image-upload-label"> üì∑ ·Äï·ÄØ·Ä∂·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫ <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="previewImage(this)"></label>
        <img id="imgPreview" class="image-preview">
        <button id="btnPost" class="btn-post" onclick="uploadAndPost()">Post ·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫</button>
    </div>

    <div id="newsFeed"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2",
        measurementId: "G-G2ZW22W3BM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const IMGBB_API_KEY = "C8d8d00185e973ebcafddd34f77a1176";

    const ADMIN_EMAIL = "uwinkyawdevelopbusinessco@gmail.com";

    let userName = localStorage.getItem("health_user_name");
    if (!userName) {
        userName = prompt("·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·Äû·ÄÑ·Ä∑·Ä∫·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´:") || "Anonymous User";
        localStorage.setItem("health_user_name", userName);
    }
    document.getElementById('userNameDisplay').innerText = "Logged in as: " + userName;

    // ·Äï·ÄØ·Ä∂·ÄÄ·Ä≠·ÄØ Preview ·Äï·Äº·Äõ·Äî·Ä∫
    function previewImage(input) {
        const preview = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { preview.src = e.target.result; preview.style.display = 'block'; }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // ·Äï·ÄØ·Ä∂·Äõ·Ä±·Ä¨ ·ÄÖ·Ä¨·Äõ·Ä±·Ä¨ ·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∑·Ä∫ Function (Senior Modified)
    async function uploadAndPost() {
        const text = document.getElementById('postContent').value.trim();
        const fileInput = document.getElementById('imageInput');
        const file = fileInput.files[0];
        const btn = document.getElementById('btnPost');

        if (!text && !file) return alert("·ÄÖ·Ä¨ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·Äï·ÄØ·Ä∂ ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·ÄÅ·ÄØ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´");

        btn.disabled = true;
        btn.innerText = "Uploading...";

        let imageUrl = "";

        try {
            // ·ÅÅ·Åã ·Äï·ÄØ·Ä∂·Äõ·Äæ·Ä≠·Äú·Äª·Äæ·ÄÑ·Ä∫ ImgBB ·Äû·Ä≠·ÄØ·Ä∑ ·Ä°·Äõ·ÄÑ·Ä∫·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫
            if (file) {
                const formData = new FormData();
                formData.append("image", file);
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                imageUrl = data.data.url;
            }

            // ·ÅÇ·Åã Firestore ·Äë·Ä≤·Äû·Ä≠·ÄØ·Ä∑ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫
            await db.collection("health_posts").add({
                author: userName,
                text: text,
                imageUrl: imageUrl, // ·Äï·ÄØ·Ä∂ Link ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
                likes: 0,
                hahas: 0,
                comments: [],
                isPinned: false,
                createdAt: Date.now()
            });

            // Clean up
            document.getElementById('postContent').value = "";
            fileInput.value = "";
            document.getElementById('imgPreview').style.display = 'none';
            alert("·Äê·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ!");

        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Post ·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫";
        }
    }

        // Feedback ·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (Index.html ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äõ·Äî·Ä∫ Senior ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äô·Äæ·ÄØ)
    async function submitFeedback() {
        const text = document.getElementById('feedbackText').value.trim();
        const btn = document.querySelector('.post-card .btn-post'); // Feedback button

        if (selectedRating === 0 || !text) return alert("·ÄÄ·Äº·Äö·Ä∫·Äï·ÄΩ·ÄÑ·Ä∑·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·ÄÖ·Ä¨·Äû·Ä¨·Ä∏ ·Äñ·Äº·Ää·Ä∑·Ä∫·ÄÖ·ÄΩ·ÄÄ·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´");

        btn.disabled = true;
        btn.innerText = "Sending...";

        try {
            // ·ÅÅ·Åã App Rating Statistic ·Äë·Ä≤·Äû·Ä≠·ÄØ·Ä∑ ·Äë·Ää·Ä∑·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            await db.collection("app_feedback").add({ 
                rating: selectedRating, 
                createdAt: Date.now() 
            });

            // ·ÅÇ·Åã News Feed ·Äô·Äæ·Ä¨ Rating ·Äï·Ä±·Ä∏·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ Post ·Ä°·Äî·Ä±·Äî·Ä≤·Ä∑ ·Äê·Äî·Ä∫·Ä∏·Äï·Äº·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            await db.collection("health_posts").add({
                author: userName, 
                text: `‚≠ê Rated the App: ${selectedRating}/5 Stars\n\n"${text}"`,
                imageUrl: "", // Feedback ·Äô·Äæ·Ä¨ ·Äï·ÄØ·Ä∂·Äô·Äï·Ä´·Äú·Ä≠·ÄØ·Ä∑ Empty ·Äë·Ä¨·Ä∏·Äï·Ä´·Äê·Äö·Ä∫
                likes: 0, 
                hahas: 0, 
                comments: [], 
                isPinned: false, 
                createdAt: Date.now()
            });

            alert("Feedback ·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ!");
            document.getElementById('feedbackText').value = ""; 
            setRating(0);
        } catch(e) { 
            alert("Error: " + e.message); 
        } finally {
            btn.disabled = false;
            btn.innerText = "Feedback ·Äï·Ä±·Ä∏·Äô·Ää·Ä∫";
        }
    }

 // Rating Snapshot ·Äô·Ä∞·Äú·Ä°·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏
    db.collection("app_feedback").onSnapshot(snap => {
        let total = 0; let counts = {1:0, 2:0, 3:0, 4:0, 5:0};
        snap.forEach(doc => {
            const r = doc.data().rating; total += r;
            if(counts[r] !== undefined) counts[r]++;
        });
        const avg = snap.size === 0 ? "0.0" : (total / snap.size).toFixed(1);
        document.getElementById('averageRatingDisplay').innerText = `‚≠ê ${avg} / 5.0`;
        for(let i=1; i<=5; i++) { document.getElementById(`c${i}`).innerText = counts[i]; }
    });

    async function adminLogin() {
        try {
            const result = await auth.signInWithPopup(provider);
            if(result.user.email === ADMIN_EMAIL) {
                alert("Welcome Admin!");
                document.getElementById('adminLoginBtn').innerText = "Admin: ON ‚úÖ";
            } else { alert("Access Denied."); await auth.signOut(); }
        } catch (e) { alert(e.message); }
    }

    let selectedRating = 0;
    function setRating(n) {
        selectedRating = n;
        document.querySelectorAll('#ratingStars span').forEach((s, i) => s.style.color = i < n ? "#ffc107" : "#ddd");
    }

    async function react(id, type, commentId = null) {
        const docRef = db.collection("health_posts").doc(id);
        const doc = await docRef.get();
        if (commentId) {
            const updated = doc.data().comments.map(c => { if(c.id === commentId) c[type] = (c[type] || 0) + 1; return c; });
            await docRef.update({ comments: updated });
        } else { await docRef.update({ [type]: firebase.firestore.FieldValue.increment(1) }); }
    }

    async function addComment(id) {
        const input = document.getElementById(`in-${id}`);
        if(!input.value.trim()) return;
        await db.collection("health_posts").doc(id).update({ comments: firebase.firestore.FieldValue.arrayUnion({ id: Date.now().toString(), author: userName, text: input.value, likes: 0, hahas: 0 }) });
        input.value = "";
    }

    async function deleteItem(postId, commentId = null) {
        if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) return alert("Admin Login Required");
        if (!confirm("Delete this?")) return;
        try {
            const docRef = db.collection("health_posts").doc(postId);
            if (commentId) {
                const doc = await docRef.get();
                const filtered = doc.data().comments.filter(c => c.id !== commentId);
                await docRef.update({ comments: filtered });
            } else { await docRef.delete(); }
        } catch(e) { alert(e.message); }
    }

    async function togglePin(id, status) {
        if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) return alert("Admin Login Required");
        await db.collection("health_posts").doc(id).update({ isPinned: !status });
    }

    // Feed Rendering ·Äô·Äæ·Ä¨ ·Äï·ÄØ·Ä∂·Äï·Ä´·Äï·Äº·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
    db.collection("health_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
        const feed = document.getElementById('newsFeed'); feed.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data(); const id = doc.id;
            const cList = (d.comments || []).map(c => `
                <div class="comment-item">
                    <div style="display:flex; justify-content:space-between;"><strong>${c.author}</strong><span class="del-btn" onclick="deleteItem('${id}', '${c.id}')">üóëÔ∏è</span></div>
                    <p>${c.text}</p>
                    <div style="font-size:11px;">
                        <span onclick="react('${id}', 'likes', '${c.id}')" style="cursor:pointer;">üëç ${c.likes || 0}</span>
                        <span onclick="react('${id}', 'hahas', '${c.id}')" style="cursor:pointer; margin-left:10px;">üòÜ ${c.hahas || 0}</span>
                    </div>
                </div>`).join('');
            
            feed.innerHTML += `
                <div class="feed-card ${d.isPinned ? 'pinned' : ''}">
                    <div style="display:flex; justify-content:space-between;">
                        <strong style="color:var(--primary);">${d.isPinned ? 'üìå PINNED' : (d.author || 'User')}</strong>
                        <div><span class="pin-btn" onclick="togglePin('${id}', ${d.isPinned})">üìç Pin</span><span class="del-btn" onclick="deleteItem('${id}')">üóëÔ∏è</span></div>
                    </div>
                    <p style="white-space:pre-wrap; margin:10px 0;">${d.text}</p>
                    ${d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%; border-radius:8px; margin-bottom:10px;">` : ''}
                    <div class="action-bar">
                        <button class="action-btn" onclick="react('${id}', 'likes')">üëç Like (${d.likes || 0})</button>
                        <button class="action-btn" onclick="react('${id}', 'hahas')">üòÜ Haha (${d.hahas || 0})</button>
                    </div>
                    <div class="comment-section">${cList}<div class="comment-input-box"><input type="text" id="in-${id}" class="comment-input"><button onclick="addComment('${id}')" style="border:none; background:none; color:purple; font-weight:bold;">Send</button></div></div>
                </div>`;
        });
    });
</script>
</body>
</html>
                                           </html>
    
