<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Community - Final Master</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root { --primary: #800080; --bg: #f0f2f5; --pinned: #fff9c4; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        .header { background: var(--primary); color: white; padding: 12px 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 500px; margin: auto; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .card.pinned { border: 2px solid #ffd700; background: var(--pinned); }
        .stat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .stat-item { font-size: 11px; background: #f8f9fa; padding: 5px; border-radius: 5px; text-align: center; }
        textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 12px; box-sizing: border-box; resize: none; font-size: 15px; background: #f5f6f7; outline: none; }
        .btn-post { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        .action-bar { display: flex; border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; justify-content: space-around; }
        .action-btn { background: none; border: none; color: #65676b; cursor: pointer; font-size: 13px; font-weight: 600; }
        .comment-item { background: #f0f2f5; border-radius: 10px; padding: 10px; margin-bottom: 8px; font-size: 13px; }
        .comment-react-bar { display: flex; gap: 15px; margin-top: 5px; font-size: 11px; color: #65676b; }
        .rating-stars { font-size: 25px; color: #ddd; cursor: pointer; display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; }
        .rating-stars span.active { color: #ffc107; }
        .admin-badge { background: #ffd700; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <div style="display:flex; align-items:center; gap:5px;">
            <div style="font-weight: bold;">Health Community</div>
            <span id="adminBadge" style="display:none;" class="admin-badge">ADMIN</span>
        </div>
        <small id="userNameDisplay">Loading...</small>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
        <button id="googleBtn" style="background:#4285F4; color:white; border:none; padding:6px 10px; border-radius:4px; font-size:11px; cursor:pointer;" onclick="loginWithGoogle()">Google Login</button>
        <a href="index.html" style="text-decoration:none; color:white; font-size:22px;">üè†</a>
    </div>
</div>

<div class="container">
    <div class="card">
        <h4 style="margin:0; text-align:center; color:var(--primary);">Application Rating</h4>
        <div id="averageRatingDisplay" style="font-size: 24px; font-weight: bold; text-align: center; margin:5px;">‚≠ê 0.0</div>
        <div class="stat-grid">
            <div class="stat-item">5‚≠ê:<br><b id="c5">0</b></div>
            <div class="stat-item">4‚≠ê:<br><b id="c4">0</b></div>
            <div class="stat-item">3‚≠ê:<br><b id="c3">0</b></div>
            <div class="stat-item">2‚≠ê:<br><b id="c2">0</b></div>
            <div class="stat-item">1‚≠ê:<br><b id="c1">0</b></div>
        </div>
    </div>

    <div id="ratingInputBox" class="card" style="display:none;">
        <h3 style="font-size: 14px; text-align:center; margin-top:0;">·Äí·ÄÆ App ·ÄÄ·Ä≠·ÄØ ·Äò·Äö·Ä∫·Äú·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ·Äº·Ä≠·ÄØ·ÄÄ·Ä∫·Äû·Äú·Ä≤?</h3>
        <div class="rating-stars" id="ratingStars">
            <span onclick="setRating(1)">‚≠ê</span><span onclick="setRating(2)">‚≠ê</span><span onclick="setRating(3)">‚≠ê</span><span onclick="setRating(4)">‚≠ê</span><span onclick="setRating(5)">‚≠ê</span>
        </div>
        <textarea id="feedbackText" rows="2" placeholder="·Ä°·ÄÄ·Äº·Ä∂·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫·Äõ·Ä±·Ä∏·Äõ·Äî·Ä∫..."></textarea>
        <button class="btn-post" onclick="submitFeedback()">Rating ·Äï·Ä±·Ä∏·Äô·Ää·Ä∫</button>
    </div>

    <div class="card">
        <textarea id="postContent" rows="3" placeholder="·ÄÄ·Äª·Äî·Ä∫·Ä∏·Äô·Ä¨·Äõ·Ä±·Ä∏ ·Äó·Äü·ÄØ·Äû·ÄØ·Äê·Äô·Äª·Ä¨·Ä∏ ·Äô·Äª·Äæ·Äù·Ä±·Äï·Ä´..."></textarea>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
            <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="previewImage(this)">
            <label for="imageInput" style="padding:8px; background:#eee; border-radius:6px; cursor:pointer; font-size:12px;">üì∑ ·Äï·ÄØ·Ä∂·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫</label>
            <button id="btnPost" class="btn-post" style="width:120px; margin:0;" onclick="uploadAndPost()">·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫</button>
        </div>
        <img id="imgPreview" style="width:100%; border-radius:8px; display:none; margin-top:10px;">
    </div>

    <div id="newsFeed"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const ADMIN_EMAIL = "uwinkyawdevelopbusinessco@gmail.com";
    const IMGBB_API_KEY = "C8d8d00185e973ebcafddd34f77a1176";

    let userName = localStorage.getItem("health_user_name") || "Guest";
    let selectedRatingValue = 0;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userName = user.displayName || localStorage.getItem("health_user_name") || "Guest";
            if (user.email === ADMIN_EMAIL) {
                userName = "Admin Developer";
                document.getElementById('adminBadge').style.display = 'block';
            }
            document.getElementById('userNameDisplay').innerText = "·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞: " + userName;
            if (user.email) document.getElementById('googleBtn').style.display = 'none';

            const rDoc = await db.collection("app_feedback").doc(user.uid).get();
            document.getElementById('ratingInputBox').style.display = rDoc.exists ? 'none' : 'block';
            startApp();
        } else {
            auth.signInAnonymously();
            if (!localStorage.getItem("health_user_name")) {
                let name = prompt("·Äû·ÄÑ·Ä∑·Ä∫·Ä°·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´:");
                localStorage.setItem("health_user_name", name || "Guest");
            }
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => alert("Popup Closed or Error: " + e.message));
    }

    function setRating(n) {
        selectedRatingValue = n;
        document.querySelectorAll('#ratingStars span').forEach((s, i) => s.classList.toggle('active', i < n));
    }

    async function submitFeedback() {
        if (selectedRatingValue === 0) return alert("·ÄÄ·Äº·Äö·Ä∫·Äï·ÄΩ·ÄÑ·Ä∑·Ä∫·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´");
        try {
            await db.collection("app_feedback").doc(auth.currentUser.uid).set({ rating: selectedRatingValue, userId: auth.currentUser.uid, createdAt: Date.now() });
            await db.collection("health_posts").add({
                author: userName,
                text: `‚≠ê App Rating: ${selectedRatingValue}/5 - "${document.getElementById('feedbackText').value}"`,
                likes: 0, hahas: 0, comments: [], isPinned: false, createdAt: Date.now()
            });
            alert("·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äê·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫!");
            document.getElementById('ratingInputBox').style.display = 'none';
        } catch (e) { alert("Permission Error: Rules ·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫·Äï·Äº·ÄÑ·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´"); }
    }

    function startApp() {
        // Stats Logic
        db.collection("app_feedback").onSnapshot(snap => {
            let total = 0, counts = {1:0, 2:0, 3:0, 4:0, 5:0};
            snap.forEach(doc => { const r = doc.data().rating; total += r; counts[r]++; });
            const avg = snap.size > 0 ? (total / snap.size).toFixed(1) : "0.0";
            document.getElementById('averageRatingDisplay').innerText = `‚≠ê ${avg} / 5.0`;
            for(let i=1; i<=5; i++) document.getElementById(`c${i}`).innerText = counts[i];
        });

        // Feed Logic
        db.collection("health_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
            const feed = document.getElementById('newsFeed');
            feed.innerHTML = "";
            const user = auth.currentUser;
            const isAdmin = user && user.email === ADMIN_EMAIL;

            snap.forEach(doc => {
                const d = doc.data(); const id = doc.id;
                const uid = user ? user.uid : null;

                let adminUI = isAdmin ? `
                    <div style="background:#f0f0f0; padding:5px; border-radius:5px; margin-bottom:8px; display:flex; gap:15px;">
                        <span style="color:blue; cursor:pointer; font-size:12px; font-weight:bold;" onclick="togglePin('${id}', ${d.isPinned})">${d.isPinned ? 'üìç Unpin' : 'üìå Pin Post'}</span>
                        <span style="color:red; cursor:pointer; font-size:12px; font-weight:bold;" onclick="deletePost('${id}')">üóëÔ∏è Delete Post</span>
                    </div>` : '';

                let commentsHtml = (d.comments || []).map(c => `
                    <div class="comment-item">
                        <b>${c.author}</b>: ${c.text}
                        <div class="comment-react-bar">
                            <span onclick="reactComment('${id}','${c.id}','likes')" style="cursor:pointer; ${(c.likedBy||[]).includes(uid)?'color:blue; font-weight:bold;':''}">üëç ${c.likes||0}</span>
                            <span onclick="reactComment('${id}','${c.id}','hahas')" style="cursor:pointer; ${(c.hahaedBy||[]).includes(uid)?'color:orange; font-weight:bold;':''}">üòÜ ${c.hahas||0}</span>
                        </div>
                    </div>`).join('');

                feed.innerHTML += `
                    <div class="card ${d.isPinned ? 'pinned' : ''}">
                        ${adminUI}
                        <div style="display:flex; justify-content:space-between"><b>${d.author}</b></div>
                        <p style="white-space:pre-wrap;">${d.text}</p>
                        ${d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%; border-radius:8px; margin-bottom:10px;">` : ''}
                        <div class="action-bar">
                            <button class="action-btn" onclick="reactPost('${id}', 'likes')" style="${(d.likedBy||[]).includes(uid)?'color:blue':''}">üëç Like (${d.likes||0})</button>
                            <button class="action-btn" onclick="reactPost('${id}', 'hahas')" style="${(d.hahaedBy||[]).includes(uid)?'color:orange':''}">üòÜ Haha (${d.hahas||0})</button>
                        </div>
                        <div style="margin-top:10px;">
                            ${commentsHtml}
                            <div style="display:flex; gap:5px; margin-top:10px;">
                                <input type="text" id="in-${id}" placeholder="·Äô·Äæ·Äê·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫..." style="flex:1; border-radius:15px; border:1px solid #ddd; padding:5px 10px;">
                                <button onclick="addComment('${id}')" style="border:none; background:none; color:purple; font-weight:bold;">Send</button>
                            </div>
                        </div>
                    </div>`;
            });
        });
    }

    async function togglePin(id, currentStatus) {
        try {
            await db.collection("health_posts").doc(id).update({ isPinned: !currentStatus });
        } catch(e) { alert("Permission Denied: Admin ·Äû·Ä¨ ·Äú·ÄØ·Äï·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äû·Ää·Ä∫"); }
    }

    async function deletePost(id) {
        if(confirm("·Äí·ÄÆ·Äï·Ä≠·ÄØ·ÄÖ·Ä∑·Ä∫·ÄÄ·Ä≠·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äæ·Ä¨ ·Äû·Ä±·ÄÅ·Äª·Ä¨·Äï·Ä´·Äû·Äú·Ä¨·Ä∏?")) {
            try {
                await db.collection("health_posts").doc(id).delete();
            } catch(e) { alert("Permission Denied"); }
        }
    }

    async function reactPost(id, type) {
        const uid = auth.currentUser.uid;
        const ref = db.collection("health_posts").doc(id);
        const doc = await ref.get();
        const data = doc.data();
        const listKey = type === 'likes' ? 'likedBy' : 'hahaedBy';
        const countKey = type === 'likes' ? 'likes' : 'hahas';

        if ((data[listKey] || []).includes(uid)) {
            await ref.update({ [listKey]: firebase.firestore.FieldValue.arrayRemove(uid), [countKey]: firebase.firestore.FieldValue.increment(-1) });
        } else {
            await ref.update({ [listKey]: firebase.firestore.FieldValue.arrayUnion(uid), [countKey]: firebase.firestore.FieldValue.increment(1) });
        }
    }

    async function reactComment(pId, cId, type) {
        const uid = auth.currentUser.uid;
        const ref = db.collection("health_posts").doc(pId);
        const doc = await ref.get();
        const comments = doc.data().comments.map(c => {
            if (c.id === cId) {
                const list = type === 'likes' ? 'likedBy' : 'hahaedBy';
                if (!c[list]) c[list] = [];
                if (c[list].includes(uid)) {
                    c[list] = c[list].filter(i => i !== uid);
                    c[type] = (c[type] || 1) - 1;
                } else {
                    c[list].push(uid);
                    c[type] = (c[type] || 0) + 1;
                }
            }
            return c;
        });
        await ref.update({ comments });
    }

    async function addComment(id) {
        const val = document.getElementById(`in-${id}`).value;
        if(!val) return;
        const newComment = { id: Date.now().toString(), author: userName, text: val, likes:0, hahas:0, likedBy:[], hahaedBy:[] };
        await db.collection("health_posts").doc(id).update({ comments: firebase.firestore.FieldValue.arrayUnion(newComment) });
        document.getElementById(`in-${id}`).value = "";
    }

    function previewImage(i) { if(i.files[0]) { const r = new FileReader(); r.onload=e=>{ const p=document.getElementById('imgPreview'); p.src=e.target.result; p.style.display='block'; }; r.readAsDataURL(i.files[0]); } }
    
    async function uploadAndPost() {
        const t = document.getElementById('postContent').value;
        const f = document.getElementById('imageInput').files[0];
        if(!t && !f) return;
        const btn = document.getElementById('btnPost'); btn.disabled = true; btn.innerText = "...";
        let url = "";
        if(f) { 
            const fd = new FormData(); fd.append("image", f);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {method:"POST", body:fd});
            const d = await res.json(); url = d.data.url;
        }
        await db.collection("health_posts").add({ author: userName, text: t, imageUrl: url, likes:0, hahas:0, comments:[], isPinned:false, createdAt: Date.now() });
        document.getElementById('postContent').value = ""; document.getElementById('imgPreview').style.display='none'; btn.disabled = false; btn.innerText = "·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫";
    }
</script>
</body>
</html>
