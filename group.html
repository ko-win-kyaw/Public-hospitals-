<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group - EmotioN</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        :root { --purple: #800080; --bg: #f0f2f5; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); padding-top: 60px; padding-bottom: 30px; display: flex; flex-direction: column; align-items: center; }
        .group-header { position: fixed; top: 0; width: 100%; height: 55px; background: var(--purple); color: white; display: flex; align-items: center; padding: 0 15px; z-index: 1000; width:100%; }
        .card { width: 95%; max-width: 500px; background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-post { background: var(--purple); color: white; }
        .btn-post:disabled { background: #ccc; cursor: not-allowed; }
        .btn-delete { background: #f44336; color: white; }
        .btn-create { background: #4caf50; color: white; }
        #groupFeed { width: 95%; max-width: 500px; }
        .post-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .post-media { width: 100%; border-radius: 8px; margin-top: 10px; max-height: 400px; object-fit: cover; background: #000; }
        .del-icon { position: absolute; top: 10px; right: 10px; color: red; cursor: pointer; font-size: 18px; border: none; background: none; }
        .interaction-bar span { font-size: 14px; color: #555; user-select: none; }
                        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; font-size: 10px; }
        .nav-item img { width: 22px; height: 22px; margin-bottom: 4px; }
        .nav-item.active { color: var(--purple); font-weight: bold; }

    </style>
</head>
<body>

    <header class="group-header">
        <span onclick="history.back()" style="cursor:pointer; margin-right:15px;">â†</span>
        <div id="displayGroupName" style="font-weight:bold;">Community Group</div>
    </header>

    <div id="joinBox" class="card" style="display:none; border: 2px solid #4caf50;">
        <h3 style="color:#4caf50; margin-bottom:10px;">Community á€‘á€²á€á€„á€ºá€›á€”á€º</h3>
        <p style="font-size:14px; color:#666; margin-bottom:10px;">Post á€á€„á€ºá€”á€­á€¯á€„á€ºá€›á€”á€ºá€¡á€á€½á€€á€º á€¡á€–á€½á€²á€·á€á€„á€ºá€¡á€›á€„á€ºá€á€„á€ºá€•á€« Seniorá‹</p>
        <button class="btn btn-create" onclick="joinGroup()">Join Community Group</button>
    </div>

    <div id="createBox" class="card" style="display:none;">
        <h3 style="color:var(--purple); margin-bottom:10px;">Group á€¡á€á€…á€ºá€á€Šá€ºá€‘á€±á€¬á€„á€ºá€™á€Šá€º</h3>
        <input type="text" id="newGroupName" placeholder="Group á€¡á€™á€Šá€º..." style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
        <button class="btn btn-create" onclick="handleCreateGroup()">Create Group</button>
    </div>

    <div id="adminBox" class="card" style="display:none;">
        <p style="font-size:14px; color:#d32f2f; font-weight:bold;">á€á€„á€ºá€á€Šá€º Group Admin á€–á€¼á€…á€ºá€á€Šá€ºá‹</p>
        <button class="btn btn-delete" onclick="handleDeleteGroup()">Delete My Group</button>
        <hr style="margin: 15px 0;">
        <div id="memberListArea" style="max-height: 200px; overflow-y: auto;">
            <h4 style="margin-bottom:10px;">ğŸ‘¥ Members List</h4>
            <div id="memberList"></div>
        </div>
    </div>

    <div id="postBox" class="card" style="display:none; border-top: 4px solid var(--purple);">
        <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <div style="width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">ğŸ‘¤</div>
            <b id="userNameDisplay" style="color: #333;">User</b>
        </div>
        <textarea id="postText" rows="3" placeholder="á€˜á€¬á€á€½á€±á€á€½á€±á€¸á€”á€±á€œá€² Senior..." style="width:100%; padding:12px; border:none; border-radius:8px; resize:none; font-size: 16px; outline: none; background: #f9f9f9;"></textarea>
        
        <div id="mediaPreviewContainer" style="display:none; margin-top: 10px; position: relative;">
            <div id="previewContent"></div>
            <button onclick="removeFile()" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; z-index: 10;">Ã—</button>
        </div>

        <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
            <label for="mediaInput" style="display: flex; align-items: center; cursor: pointer; color: #555; font-size: 14px; width: fit-content;">
                <span style="font-size: 20px; margin-right: 8px;">ğŸ–¼ï¸</span> Photo/Video á€á€„á€ºá€™á€Šá€º
            </label>
            <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;" onchange="previewMedia(this)">
        </div>
        <button id="submitBtn" class="btn btn-post" onclick="handlePost()" style="margin-top: 15px; border-radius: 25px;">Post á€á€„á€ºá€™á€Šá€º</button>
    </div>

    <div id="commentModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center; padding: 20px;">
        <div class="card" style="width:100%; max-height:80%; overflow-y:auto; position:relative;">
            <button onclick="closeComments()" style="position:absolute; top:10px; right:10px; border:none; background:none; font-size:20px; cursor:pointer;">Ã—</button>
            <h3 style="color:var(--purple); margin-bottom:15px;">Comments</h3>
            <div id="commentsList" style="margin-bottom:15px;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="commentInput" placeholder="Comment á€›á€±á€¸á€•á€«..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
                <button class="btn-post" onclick="submitComment()" style="padding:10px 15px; border-radius:8px; border:none; cursor:pointer; background:var(--purple); color:white;">Send</button>
            </div>
        </div>
    </div>

    <div id="groupFeed"></div>
    <nav class="bottom-nav">
        <a href="user.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/1946/1946488.png"><span data-lang="nav_user">User</span>
        </a>

        <a href="chat.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/589/589708.png"><span data-lang="nav_chat">Chat</span>
        </a>
        <a href="live.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/4404/4404094.png"><span data-lang="nav_live">Live</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png"><span data-lang="nav_profile">Profile</span>
        </a>
    </nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4Yiez3VXKD90za0wnt03lFPjeln4su7U",
        authDomain: "hospital-app-caf85.firebaseapp.com",
        projectId: "hospital-app-caf85",
        storageBucket: "hospital-app-caf85.firebasestorage.app",
        messagingSenderId: "736486429191",
        appId: "1:736486429191:web:25c116beb3994d213cd0a2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const IMGBB_KEY = "C8d8d00185e973ebcafddd34f77a1176"; 
    const DEVELOPER_UID = "JmfslTvO9SYQfpGdaKxtwBkBxQh2"; 

    let currentGroupAdmin = "";
    let activePostId = "";

    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('userNameDisplay').innerText = user.displayName || "User";
            checkUserStatus(user.uid);
            loadPosts();
        } else { window.location.href = "login.html"; }
    });

async function checkUserStatus(uid) {
    try {
        // --- áá‹ Group á€¡á€™á€Šá€ºá€€á€­á€¯ Header á€™á€¾á€¬ á€•á€¼á€•á€±á€¸á€›á€”á€º á€•á€±á€«á€„á€ºá€¸á€‘á€Šá€·á€ºá€‘á€¬á€¸á€á€±á€¬á€¡á€•á€­á€¯á€„á€ºá€¸ ---
        const groupSnap = await db.collection("groups").limit(1).get();
        if (!groupSnap.empty) {
            const groupData = groupSnap.docs[0].data();
            const headerTitle = document.getElementById('displayGroupName');
            if (headerTitle) {
                headerTitle.innerText = groupData.groupName; // Admin á€•á€±á€¸á€‘á€¬á€¸á€á€²á€· á€”á€¬á€™á€Šá€ºá€€á€­á€¯ á€•á€¼á€•á€«á€™á€šá€º
            }
        }
        // -----------------------------------------------------------

        const adminSnap = await db.collection("groups").where("createdBy", "==", uid).limit(1).get();
        const memberSnap = await db.collection("group_members").where("uid", "==", uid).limit(1).get();
        
        document.getElementById('createBox').style.display = "none";
        document.getElementById('adminBox').style.display = "none";
        document.getElementById('postBox').style.display = "none";
        document.getElementById('joinBox').style.display = "none";

        if (!adminSnap.empty) {
            document.getElementById('adminBox').style.display = "block";
            document.getElementById('postBox').style.display = "block";
            currentGroupAdmin = uid;
            loadMembers();
        } else if (!memberSnap.empty) {
            document.getElementById('postBox').style.display = "block";
            // Member á€¡á€á€½á€€á€ºá€œá€Šá€ºá€¸ Admin UID á€€á€­á€¯ á€á€­á€‘á€¬á€¸á€–á€­á€¯á€· á€œá€­á€¯á€¡á€•á€ºá€œá€­á€¯á€· á€†á€½á€²á€šá€°á€á€¼á€„á€ºá€¸
            if (!groupSnap.empty) currentGroupAdmin = groupSnap.docs[0].data().createdBy;
        } else {
            document.getElementById('joinBox').style.display = "block";
            document.getElementById('createBox').style.display = "block";
        }
    } catch (e) { 
        console.error("User Status Error: ", e); 
    }
}
function loadPosts() {
    const feed = document.getElementById('groupFeed');
    if(!feed) return;

    db.collection("group_posts").orderBy("isPinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
        const uid = auth.currentUser ? auth.currentUser.uid : "visitor";
        const isAdmin = (uid === DEVELOPER_UID || uid === currentGroupAdmin);

        snap.docChanges().forEach(change => {
            const id = change.doc.id;
            const d = change.doc.data();
            let postEl = document.getElementById(`post-${id}`);

            if (change.type === "added" && !postEl) {
                const div = document.createElement('div');
                div.id = `post-${id}`;
                div.className = "post-card";
                // Null safety á€¡á€á€½á€€á€º d.isPinned á€€á€­á€¯ á€…á€…á€ºá€‘á€¬á€¸á€•á€«á€á€šá€º
                div.style = `background:white; margin-bottom:15px; padding:15px; border-radius:12px; color:black; border:${d.isPinned ? '2px solid purple' : 'none'}; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position:relative;`;
                div.innerHTML = renderPostHTML(id, d, uid, isAdmin);
                
                // Pin á€œá€¯á€•á€ºá€‘á€¬á€¸á€›á€„á€º á€‘á€­á€•á€ºá€†á€¯á€¶á€¸á€•á€­á€¯á€·á€™á€šá€ºáŠ á€™á€Ÿá€¯á€á€ºá€›á€„á€º á€¡á€…á€‰á€ºá€œá€­á€¯á€€á€ºá€•á€¼á€™á€šá€º
                if (d.isPinned) feed.prepend(div); else feed.appendChild(div);
            } 
            else if (change.type === "modified" && postEl) {
                // á€¡á€á€»á€­á€”á€ºá€á€½á€€á€ºá€á€²á€· line á€€á€­á€¯ á€–á€šá€ºá€œá€­á€¯á€€á€ºá€•á€«á€á€šá€º (Reaction á€¡á€á€½á€€á€º á€™á€œá€­á€¯á€œá€­á€¯á€·á€•á€«)
                const reactionArea = postEl.querySelector('.interaction-bar'); 
                if (reactionArea) {
                    reactionArea.innerHTML = `
                        <div style="display:flex; gap:18px;">
                            <span onclick="react('${id}', 'likes')" style="cursor:pointer; font-weight:bold;">ğŸ‘ ${d.likes||0}</span>
                            <span onclick="react('${id}', 'hahas')" style="cursor:pointer; font-weight:bold;">ğŸ˜† ${d.hahas||0}</span>
                            <span onclick="showComments('${id}')" style="cursor:pointer; font-weight:bold;">ğŸ’¬ ${d.comments||0}</span>
                        </div>
                        <span onclick="sharePost('${id}')" style="cursor:pointer; color:var(--purple); font-weight:bold;">ğŸš€ Share</span>
                    `;
                }
                
                // Pin Status á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€™á€¾á€¯á€€á€­á€¯ Update á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
                postEl.style.border = d.isPinned ? '2px solid purple' : 'none';
                const pinBtnArea = postEl.querySelector('.pin-btn-area');
                if (pinBtnArea && isAdmin) {
                    pinBtnArea.innerHTML = `<button onclick="togglePin('${id}', ${d.isPinned || false})" style="border:none; background:none; cursor:pointer; font-size:18px;">${d.isPinned ? 'ğŸ“Œ' : 'ğŸ“'}</button>`;
                }
            } 
            else if (change.type === "removed" && postEl) { 
                postEl.remove(); 
            }
        });
    });
}

    function renderPostHTML(id, d, uid, isAdmin) {
        const timeDisplay = formatTime(d.createdAt);
        const isMe = (uid === d.uid);
        let media = "";
        if (d.mediaUrl) {
            media = (d.mediaType === 'video' || d.mediaUrl.includes('.mp4')) ? 
                `<video src="${d.mediaUrl}" controls playsinline class="post-media"></video>` : 
                `<img src="${d.mediaUrl}" class="post-media">`;
        }

        return `
            <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px; align-items:center;">
                <div class="pin-btn-area">${isAdmin ? `<button onclick="togglePin('${id}', ${d.isPinned || false})" style="border:none; background:none; cursor:pointer; font-size:18px;">${d.isPinned ? 'ğŸ“Œ' : 'ğŸ“'}</button>` : ''}</div>
                ${(isAdmin || isMe) ? `<button onclick="deletePost('${id}')" style="border:none; background:none; cursor:pointer; font-size:18px;">ğŸ—‘ï¸</button>` : ''}
            </div>
            <div style="margin-bottom:10px;">
                <b style="color:var(--purple); font-size:15px;">${d.author}</b><br>
                <small style="color:gray; font-size:11px;">${timeDisplay}</small>
            </div>
            <p style="white-space:pre-wrap; font-size:14px; color:#333;">${d.text || ""}</p>
            ${media}
            <div class="interaction-bar" style="display:flex; justify-content:space-between; margin-top:12px; border-top:1px solid #eee; padding-top:10px;">
                <div style="display:flex; gap:18px;">
                    <span onclick="react('${id}', 'likes')" style="cursor:pointer; font-weight:bold;">ğŸ‘ ${d.likes||0}</span>
                    <span onclick="react('${id}', 'hahas')" style="cursor:pointer; font-weight:bold;">ğŸ˜† ${d.hahas||0}</span>
                    <span onclick="showComments('${id}')" style="cursor:pointer; font-weight:bold;">ğŸ’¬ ${d.comments||0}</span>
                </div>
                <span onclick="sharePost('${id}')" style="cursor:pointer; color:var(--purple); font-weight:bold;">ğŸš€ Share</span>
            </div>`;
    }

    // Toggle Pin Function á€œá€±á€¸á€œá€Šá€ºá€¸ á€‘á€Šá€·á€ºá€•á€±á€¸á€‘á€¬á€¸á€•á€«á€á€šá€º
    async function togglePin(id, currentStatus) {
        try { await db.collection("group_posts").doc(id).update({ isPinned: !currentStatus }); } catch (e) { console.error(e); }
    }

  async function showComments(postId) {
        activePostId = postId;
        document.getElementById('commentModal').style.display = "flex";
        const list = document.getElementById('commentsList');
        db.collection("group_posts").doc(postId).collection("comments").orderBy("createdAt", "asc").onSnapshot(snap => {
            list.innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                list.innerHTML += `<div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:8px;">
                    <b>${c.author}</b><p>${c.text}</p>
                    <div style="font-size:12px; margin-top:5px;">
                        <span onclick="reactComment('${postId}', '${doc.id}', 'likes')" style="cursor:pointer; margin-right:10px;">ğŸ‘ ${c.likes || 0}</span>
                        <span onclick="reactComment('${postId}', '${doc.id}', 'hahas')" style="cursor:pointer;">ğŸ˜† ${c.hahas || 0}</span>
                    </div></div>`;
            });
        });
    }

    async function submitComment() {
        const text = document.getElementById('commentInput').value.trim();
        if (!text || !activePostId) return;
        await db.collection("group_posts").doc(activePostId).collection("comments").add({
            text: text, uid: auth.currentUser.uid, author: auth.currentUser.displayName || "User",
            likes: 0, hahas: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection("group_posts").doc(activePostId).update({ comments: firebase.firestore.FieldValue.increment(1) });
        document.getElementById('commentInput').value = "";
    }
async function reactComment(postId, commentId, type) {
    const user = auth.currentUser;
    if (!user) return;

    const commentRef = db.collection("group_posts").doc(postId).collection("comments").doc(commentId);
    const reactionRef = commentRef.collection("reactions").doc(user.uid);

    let isNewReaction = false;
    let commentOwnerId = null;

    try {
        await db.runTransaction(async (transaction) => {
            const commentDoc = await transaction.get(commentRef);
            const reactionDoc = await transaction.get(reactionRef);

            if (!commentDoc.exists) return;

            let commentData = commentDoc.data();
            commentOwnerId = commentData.uid;
            let likes = commentData.likes || 0;
            let hahas = commentData.hahas || 0;

            if (reactionDoc.exists) {
                const oldType = reactionDoc.data().type;
                if (oldType === type) {
                    if (type === "likes") likes = Math.max(0, likes - 1);
                    if (type === "hahas") hahas = Math.max(0, hahas - 1);
                    transaction.delete(reactionRef);
                } else {
                    if (oldType === "likes") likes = Math.max(0, likes - 1);
                    if (oldType === "hahas") hahas = Math.max(0, hahas - 1);
                    if (type === "likes") likes++;
                    if (type === "hahas") hahas++;
                    transaction.update(reactionRef, { type: type });
                }
            } else {
                if (type === "likes") likes++;
                if (type === "hahas") hahas++;
                transaction.set(reactionRef, { type: type, uid: user.uid });
                isNewReaction = true;
            }
            transaction.update(commentRef, { likes: likes, hahas: hahas });
        });

        // Notification á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
        if (isNewReaction && commentOwnerId && commentOwnerId !== user.uid) {
            const reactionEmoji = type === "likes" ? "ğŸ‘" : "ğŸ˜†";
            await db.collection("notifications").add({
                receiverId: commentOwnerId,
                senderId: user.uid,
                title: "Reaction á€¡á€á€…á€ºá€›á€¾á€­á€•á€«á€á€Šá€º",
                body: `${user.displayName || "User"} á€€ á€á€„á€ºá Comment á€€á€­á€¯ ${reactionEmoji} á€•á€±á€¸á€œá€­á€¯á€€á€ºá€•á€«á€á€šá€º`,
                status: "unread",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    } catch (e) { console.error("Reaction Error: ", e); }
}


async function handlePost() {
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('mediaInput').files[0];
    const btn = document.getElementById('submitBtn');
    
    // BunnyCDN Settings
    const BUNNY_KEY = "a038d7e1-bf94-448b-b863c156422e-7e4a-4299"; 
    const BUNNY_STORAGE = "public-hospitals";

    if (!text && !file) return;

    btn.disabled = true;
    btn.innerHTML = "á€á€„á€ºá€”á€±á€á€Šá€º... â³";

    try {
        let mediaUrl = "", mediaType = "";
        if (file) {
            const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
            
            if (file.type.startsWith('video/')) {
                // --- Video á€á€„á€ºá€á€¼á€„á€ºá€¸ (BunnyCDN) ---
                mediaType = 'video';
                const res = await fetch(`https://sg.storage.bunnycdn.com/${BUNNY_STORAGE}/${fileName}`, {
                    method: 'PUT',
                    headers: { 'AccessKey': BUNNY_KEY },
                    body: file
                });
                if (res.ok) {
                    mediaUrl = `https://public-hospitals.b-cdn.net/${fileName}`;
                } else {
                    throw new Error("Video á€á€„á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€”á€±á€•á€«á€á€Šá€º");
                }
            } else {
                // --- Image á€á€„á€ºá€á€¼á€„á€ºá€¸ (ImgBB) ---
                mediaType = 'image';
                const fd = new FormData();
                fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { 
                    method: 'POST', 
                    body: fd 
                });
                const d = await res.json();
                if (d.success) { 
                    mediaUrl = d.data.url; 
                } else {
                    throw new Error("Image á€á€„á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€”á€±á€•á€«á€á€Šá€º");
                }
            }
        }

        // --- Database á€‘á€²á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€á€¼á€„á€ºá€¸ (isPinned á€•á€«á€á€„á€ºá€á€Šá€º) ---
        await db.collection("group_posts").add({
            text: text, 
            mediaUrl: mediaUrl, 
            mediaType: mediaType, 
            uid: auth.currentUser.uid, 
            author: auth.currentUser.displayName || "User", 
            groupAdminUid: currentGroupAdmin || DEVELOPER_UID,
            likes: 0, 
            hahas: 0, 
            comments: 0, 
            isPinned: false, // á€•á€­á€¯á€…á€·á€ºá€¡á€á€…á€ºá€á€„á€ºá€á€­á€¯á€„á€ºá€¸ Pin á€™á€œá€¯á€•á€ºá€á€±á€¸á€á€²á€· status á€”á€²á€· á€á€½á€¬á€¸á€•á€«á€™á€šá€º
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Form á€€á€­á€¯ Clean á€•á€¼á€”á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
        document.getElementById('postText').value = ""; 
        removeFile();
        alert("á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€® Senior!");
    } catch (e) { 
        alert("Error: " + e.message); 
    }
    
    btn.disabled = false;
    btn.innerHTML = "Post á€á€„á€ºá€™á€Šá€º";
}

function previewMedia(input) {
    const file = input.files[0];
    const preview = document.getElementById('previewContent');
    const container = document.getElementById('mediaPreviewContainer');
    preview.innerHTML = "";
    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            if (file.type.startsWith('image/')) {
                preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; border-radius: 8px; max-height: 300px; object-fit: cover;">`;
            } else if (file.type.startsWith('video/')) {
                preview.innerHTML = `<video src="${e.target.result}" style="width: 100%; border-radius: 8px; max-height: 300px;" muted autoplay loop></video>`;
            }
            container.style.display = "block";
        };
        reader.readAsDataURL(file);
    }
}

    function removeFile() { document.getElementById('mediaInput').value = ""; document.getElementById('mediaPreviewContainer').style.display = "none"; }

    async function joinGroup() {
        try {
            await db.collection("group_members").doc(auth.currentUser.uid).set({
                uid: auth.currentUser.uid, displayName: auth.currentUser.displayName || "User", joinedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Joined!"); location.reload();
        } catch (e) { alert(e.message); }
    }

    async function loadMembers() {
        const list = document.getElementById('memberList');
        db.collection("group_members").onSnapshot(snap => {
            list.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                const isMe = auth.currentUser.uid === m.uid;
                list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:5px 0;">
                    <span>${m.displayName}</span>
                    ${(!isMe && auth.currentUser.uid === currentGroupAdmin) ? `<button onclick="kickMember('${doc.id}')" style="color:red; border:none; background:none;">Kick</button>` : ""}
                </div>`;
            });
        });
    }

    async function kickMember(id) { if (confirm("Kick?")) await db.collection("group_members").doc(id).delete(); }

   async function sharePost(postId) {
    const postSnap = await db.collection("group_posts").doc(postId).get();
    const d = postSnap.data();
    const myUid = auth.currentUser.uid;

    await db.collection("health_posts").add({
        text: d.text, 
        mediaUrl: d.mediaUrl, 
        mediaType: d.mediaType, 
        uid: myUid,
        author: auth.currentUser.displayName || "User", 
        isShared: true, 
        originalAuthor: d.author, 
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    if (d.uid !== myUid) {
        await db.collection("notifications").add({
            receiverId: d.uid,
            senderId: myUid,
            title: "Post Shared ğŸ”",
            body: `${auth.currentUser.displayName || "User"} á€€ á€á€„á€ºá Post á€€á€­á€¯ Share á€œá€­á€¯á€€á€ºá€•á€«á€á€šá€º`,
            status: "unread",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
    alert("Shared to profile!");
}

  async function deletePost(id) { if (confirm("á€–á€»á€€á€ºá€™á€¾á€¬á€œá€¬á€¸ Senior?")) await db.collection("group_posts").doc(id).delete(); }

    function closeComments() { document.getElementById('commentModal').style.display = "none"; }

    async function handleCreateGroup() {
        const name = document.getElementById('newGroupName').value.trim();
        if(!name) return;
        await db.collection("groups").add({ groupName: name, createdBy: auth.currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        location.reload();
    }

    async function handleDeleteGroup() {
        if (!confirm("Delete Group?")) return;
        const snap = await db.collection("groups").where("createdBy", "==", auth.currentUser.uid).get();
        snap.forEach(async (doc) => { await db.collection("groups").doc(doc.id).delete(); });
        location.reload();
    }
    function formatTime(timestamp) {
    if (!timestamp) return "á€á€¯á€”á€€á€á€„á€º"; // Server á€€ á€¡á€á€»á€­á€”á€ºá€™á€•á€¼á€”á€ºá€•á€±á€¸á€á€±á€¸á€á€„á€ºá€™á€¾á€¬ á€•á€¼á€–á€­á€¯á€·
    const date = timestamp.toDate();   // Firebase Timestamp á€€á€­á€¯ JS Date á€•á€¼á€±á€¬á€„á€ºá€¸á€á€¬
    const now = new Date();            // á€œá€€á€ºá€›á€¾á€­á€¡á€á€»á€­á€”á€º
    const diff = Math.floor((now - date) / 1000); // á€…á€€á€¹á€€á€”á€·á€ºá€á€¼á€¬á€¸á€”á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€á€½á€€á€ºá€á€¬

    if (diff < 60) return "á€á€¯á€”á€€á€á€„á€º";
    if (diff < 3600) return Math.floor(diff / 60) + " á€™á€­á€”á€…á€ºá€á€”á€·á€ºá€€";
    if (diff < 86400) return Math.floor(diff / 3600) + " á€”á€¬á€›á€®á€á€”á€·á€ºá€€";
    
    // á‚á„ á€”á€¬á€›á€®á€‘á€€á€º á€€á€»á€±á€¬á€ºá€á€½á€¬á€¸á€›á€„á€ºá€á€±á€¬á€· á€›á€€á€ºá€…á€½á€²á€¡á€á€­á€¯á€„á€ºá€¸ á€•á€¼á€œá€­á€¯á€€á€ºá€á€¬á€•á€«
    return date.toLocaleDateString('my-MM', { day: 'numeric', month: 'short' });
}
async function react(postId, type) {
    const user = auth.currentUser;
    if (!user) return;

    const postRef = db.collection("group_posts").doc(postId);
    const reactionRef = postRef.collection("reactions").doc(user.uid);

    await db.runTransaction(async (transaction) => {
        const postDoc = await transaction.get(postRef);
        const reactionDoc = await transaction.get(reactionRef);

        let postData = postDoc.data() || {};
        let likes = postData.likes || 0;
        let hahas = postData.hahas || 0;

        if (reactionDoc.exists) {
            const oldType = reactionDoc.data().type;
            if (oldType === type) {
                if (type === "likes") likes--;
                if (type === "hahas") hahas--;
                transaction.delete(reactionRef);
            } else {
                if (oldType === "likes") likes--;
                if (oldType === "hahas") hahas--;
                if (type === "likes") likes++;
                if (type === "hahas") hahas++;
                transaction.update(reactionRef, { type });
            }
        } else {
            if (type === "likes") likes++;
            if (type === "hahas") hahas++;
            transaction.set(reactionRef, { type, uid: user.uid });

            // Notification á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸ (Reaction á€¡á€á€…á€ºá€–á€¼á€…á€ºá€™á€¾ á€•á€­á€¯á€·á€›á€”á€º)
            const postOwnerId = postData.uid;
            if (postOwnerId !== user.uid) {
                const emoji = type === "likes" ? "ğŸ‘" : "ğŸ˜†";
                db.collection("notifications").add({
                    receiverId: postOwnerId,
                    senderId: user.uid,
                    title: "Reaction á€¡á€á€…á€º",
                    body: `${user.displayName || "User"} á€€ á€á€„á€ºá Post á€€á€­á€¯ ${emoji} á€•á€±á€¸á€œá€­á€¯á€€á€ºá€•á€«á€á€šá€º`,
                    status: "unread",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        transaction.update(postRef, {
            likes: likes,
            hahas: hahas
        });
    });
}

</script>
</body>
  
</html>
